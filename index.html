<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonlinear Regression Analysis</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Regression App">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#000000">
    
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    
    <style>
        /* All existing CSS remains exactly the same, just add these new styles at the end: */
        
        /* PWA Header Styles */
        .pwa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 7px;
            padding: 0 5px;
        }
        
        .pwa-title {
            display: flex;
            align-items: center;
            gap: 7px;
        }
        
        .pwa-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .pwa-button {
            background: #000;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .pwa-button:hover {
            background: #333;
        }
        
        .pwa-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .pwa-button.install {
            background: #4CAF50;
        }
        
        .pwa-button.install:hover {
            background: #45a049;
        }
        
        .pwa-button.save {
            background: #2196F3;
        }
        
        .pwa-button.save:hover {
            background: #1976D2;
        }
        
        .pwa-button.delete {
            background: #f44336;
        }
        
        .pwa-button.delete:hover {
            background: #d32f2f;
        }
        
        /* Session Management Modal */
        .session-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 15px;
            border-radius: 4px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .modal-header h2 {
            color: #333;
            font-size: 18px;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .session-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .session-item:last-child {
            border-bottom: none;
        }
        
        .session-item:hover {
            background-color: #f9f9f9;
        }
        
        .session-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .session-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .session-date {
            font-size: 11px;
            color: #666;
        }
        
        .session-actions {
            display: flex;
            gap: 5px;
        }
        
        .load-session-btn, .delete-session-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .load-session-btn {
            color: #2196F3;
            border-color: #2196F3;
        }
        
        .load-session-btn:hover {
            background: #2196F3;
            color: white;
        }
        
        .delete-session-btn {
            color: #f44336;
            border-color: #f44336;
        }
        
        .delete-session-btn:hover {
            background: #f44336;
            color: white;
        }
        
        .save-session-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .save-session-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
        }
        
        .save-session-btn:hover {
            background: #45a049;
        }
        
        .empty-sessions {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 12px;
            z-index: 1001;
            display: none;
        }
        
        .offline-indicator.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        ‚ö†Ô∏è You are currently offline. Some features may be limited.
    </div>
    
    <!-- Session Management Modal -->
    <div id="sessionModal" class="session-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Saved Sessions</h2>
                <button class="close-modal" onclick="closeSessionModal()">√ó</button>
            </div>
            
            <div class="session-list" id="sessionList">
                <!-- Sessions will be loaded here -->
            </div>
            
            <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                <h3 style="margin-bottom: 10px; font-size: 16px;">Save Current Session</h3>
                <input type="text" id="sessionNameInput" class="save-session-input" 
                       placeholder="Enter session name (e.g., 'Protein Binding Experiment')">
                <button class="save-session-btn" onclick="saveCurrentSession()">üíæ Save Current Session</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- PWA Header -->
        <div class="pwa-header">
            <div class="pwa-title">
                <h1>Nonlinear Regression Analysis</h1>
                <span id="appStatus" style="font-size: 11px; color: #666;"></span>
            </div>
            <div class="pwa-controls">
                <button id="installButton" class="pwa-button install" style="display: none;">
                    üì± Install App
                </button>
                <button id="saveButton" class="pwa-button save" style="display: none;" onclick="openSessionModal()">
                    üíæ Save Session
                </button>
            </div>
        </div>
        
        <!-- Rest of your existing HTML remains exactly the same -->
        <div class="main-grid">
            <!-- 1. Input Data (X and Y) - 20% width -->
            <div class="section">
                <h2>1. Input Data (X and Y)</h2>
                
                <div class="data-input-container">
                    <div class="data-header">
                        <div>X Data</div>
                        <div>Y Data</div>
                    </div>
                    
                    <div class="data-grid" id="dataGrid">
                        <!-- Data cells will be generated here -->
                    </div>
                    
                    <div class="data-controls">
                        <button onclick="addRow()">Add Row</button>
                        <button onclick="clearData()">Clear All</button>
                    </div>
                </div>
                
                <div class="status-bar">
                    <div class="point-count">Data Points: <span id="pointCount">0</span></div>
                    <div class="plot-status" id="plotStatus">No data plotted</div>
                </div>
                <div id="dataError"></div>
            </div>
            
            <!-- 2. Function Definition - 30% width -->
            <div class="section">
                <h2>2. Function Definition</h2>
                <div class="input-group">
                    <label for="funcInput">Function (use x, <span class="param-red">c1</span>, <span class="param-red">c2</span>, ... <span class="param-red">c10</span>):</label>
                    <input type="text" id="funcInput" placeholder="c1*x^2 + c2*x + c3" value="c1*x^2 + c2*x + c3">
                    <small>Example: <span class="param-red">c1</span>*x^2 + <span class="param-red">c2</span>*x + <span class="param-red">c3</span></small>
                </div>
                
                <div class="input-group" style="margin-top: 5px;">
                    <label for="constraints">Constraints (optional):</label>
                    <input type="text" id="constraints" placeholder="c1>0, c2<10, c3>=0">
                    <small>Format: <span class="param-red">c1</span>>0, <span class="param-red">c2</span>&lt;10, <span class="param-red">c3</span>&gt;=0, etc.</small>
                </div>
                
                <div class="function-status" id="functionStatus">
                    <div>Function Status:</div>
                    <div class="function-valid" id="functionValidStatus">Ready</div>
                </div>
                
                <div class="compact-section">
                    <h3>3. Initial Parameter Values</h3>
                    <div class="compact-param-grid">
                        <div class="param-input">
                            <label><span class="param-red">c1</span>:</label>
                            <input type="text" id="c1" value="1.0">
                        </div>
                        <div class="param-input">
                            <label><span class="param-red">c2</span>:</label>
                            <input type="text" id="c2" value="1.0">
                        </div>
                        <div class="param-input">
                            <label><span class="param-red">c3</span>:</label>
                            <input type="text" id="c3" value="1.0">
                        </div>
                        <div class="param-input">
                            <label><span class="param-red">c4</span>:</label>
                            <input type="text" id="c4" value="1.0">
                        </div>
                        <div class="param-input">
                            <label><span class="param-red">c5</span>:</label>
                            <input type="text" id="c5" value="1.0">
                        </div>
                    </div>
                    
                    <div class="compact-param-grid">
                        <div class="param-input">
                            <label><span class="param-red">c6</span>:</label>
                            <input type="text" id="c6" value="1.0">
                        </div>
                        <div class="param-input">
                            <label><span class="param-red">c7</span>:</label>
                            <input type="text" id="c7" value="1.0">
                        </div>
                        <div class="param-input">
                            <label><span class="param-red">c8</span>:</label>
                            <input type="text" id="c8" value="1.0">
                        </div>
                        <div class="param-input">
                            <label><span class="param-red">c9</span>:</label>
                            <input type="text" id="c9" value="1.0">
                        </div>
                        <div class="param-input">
                            <label><span class="param-red">c10</span>:</label>
                            <input type="text" id="c10" value="1.0">
                        </div>
                    </div>
                    
                    <button class="run-regression-btn" onclick="runRegression()">Run Regression</button>
                    <div id="functionError"></div>
                </div>
            </div>
            
            <!-- 3. Data with initial function fit - 35% width (reduced from 50%) -->
            <div class="section plot-section">
                <h2>3. Data with Initial Function Fit</h2>
                <div class="plot-container" id="plotDiv"></div>
            </div>
        </div>
        
        <div id="resultsSection" style="display: none;">
            <div class="results">
                <h2>Optimized Parameters</h2>
                <div class="results-grid" id="optimizedParams"></div>
                
                <h2 style="margin-top: 6px;">Goodness of Fit</h2>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">R (Correlation)</div>
                        <div class="stat-value" id="rValue">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">R¬≤ (R-squared)</div>
                        <div class="stat-value" id="r2Value">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Adjusted R¬≤</div>
                        <div class="stat-value" id="adjR2Value">-</div>
                    </div>
                </div>
                
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">RMSE</div>
                        <div class="stat-value" id="rmseValue">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">MAE</div>
                        <div class="stat-value" id="maeValue">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">AIC</div>
                        <div class="stat-value" id="aicValue">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">F-Statistic</div>
                        <div class="stat-value" id="fStatValue">-</div>
                    </div>
                </div>
                
                <div class="advanced-stats">
                    <h3>Parameter Statistics</h3>
                    <table class="param-table" id="paramStatsTable">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                                <th>Std Error</th>
                                <th>t-Statistic</th>
                                <th>p-value</th>
                                <th>Significance</th>
                            </tr>
                        </thead>
                        <tbody id="paramStatsBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="export-section">
                    <h3>
                        <span>üìã Export Results to Excel</span>
                    </h3>
                    <p style="color: #666; margin-bottom: 5px; font-size: 12px;">
                        Copy the tables below and paste directly into Excel. Each section is formatted for easy Excel import.
                    </p>
                    
                    <div class="copy-buttons">
                        <button class="copy-button" onclick="copyAllResults()">üìã Copy All Results</button>
                        <button class="copy-button" onclick="copyGoodnessOfFit()">üìä Copy Goodness of Fit</button>
                        <button class="copy-button" onclick="copyParameterStats()">üî¢ Copy Parameter Statistics</button>
                        <button class="copy-button" onclick="copyRegressionEquation()">üìê Copy Regression Equation</button>
                    </div>
                    
                    <div style="margin-top: 6px;">
                        <h4 style="color: #000; margin-bottom: 3px; font-size: 13px;">Goodness of Fit Metrics</h4>
                        <table class="export-table" id="exportGoodnessTable">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="exportGoodnessBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 6px;">
                        <h4 style="color: #000; margin-bottom: 3px; font-size: 13px;">Parameter Statistics</h4>
                        <table class="export-table" id="exportParamTable">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Value</th>
                                    <th>Std Error</th>
                                    <th>t-Statistic</th>
                                    <th>p-value</th>
                                    <th>Significance</th>
                                </tr>
                            </thead>
                            <tbody id="exportParamBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 6px;">
                        <h4 style="color: #000; margin-bottom: 3px; font-size: 13px;">Regression Summary</h4>
                        <table class="export-table" id="exportSummaryTable">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="exportSummaryBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="copyNotification" class="copy-notification" style="display: none;"></div>

    <script>
        // === PWA AND SESSION MANAGEMENT CODE ===
        
        // Check if app is installed as PWA
        function isPWAInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }
        
        // Check if browser supports IndexedDB (for session storage)
        const supportsIndexedDB = 'indexedDB' in window;
        
        // Session storage using IndexedDB
        const DB_NAME = 'regressionAppDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'sessions';
        
        let db;
        let deferredPrompt;
        
        // Initialize IndexedDB
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (!supportsIndexedDB) {
                    reject('IndexedDB not supported');
                    return;
                }
                
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object store if it doesn't exist
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        }
        
        // Save session to IndexedDB
        async function saveSession(sessionName) {
            if (!supportsIndexedDB || !db) {
                alert('Session saving is not supported in your browser.');
                return;
            }
            
            if (!sessionName || sessionName.trim() === '') {
                alert('Please enter a session name.');
                return;
            }
            
            try {
                // Collect all current data
                const sessionData = {
                    id: Date.now().toString(),
                    name: sessionName.trim(),
                    date: new Date().toISOString(),
                    data: {
                        xData: xData,
                        yData: yData,
                        funcInput: document.getElementById('funcInput').value,
                        constraints: document.getElementById('constraints').value,
                        parameters: {
                            c1: document.getElementById('c1').value,
                            c2: document.getElementById('c2').value,
                            c3: document.getElementById('c3').value,
                            c4: document.getElementById('c4').value,
                            c5: document.getElementById('c5').value,
                            c6: document.getElementById('c6').value,
                            c7: document.getElementById('c7').value,
                            c8: document.getElementById('c8').value,
                            c9: document.getElementById('c9').value,
                            c10: document.getElementById('c10').value
                        },
                        results: currentRegressionResults ? {
                            stats: currentRegressionResults.stats,
                            optimizedParams: currentRegressionResults.optimizedParams
                        } : null
                    }
                };
                
                // Also save the data grid cells
                sessionData.data.gridCells = dataCells.map(cell => ({
                    x: cell.x.textContent,
                    y: cell.y.textContent
                }));
                
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(sessionData);
                
                request.onsuccess = () => {
                    console.log('Session saved:', sessionName);
                    loadSessions(); // Refresh session list
                    
                    // Clear input and close modal
                    document.getElementById('sessionNameInput').value = '';
                    closeSessionModal();
                    
                    // Show success message
                    showCopyNotification(`Session "${sessionName}" saved successfully!`);
                };
                
                request.onerror = (event) => {
                    console.error('Error saving session:', event.target.error);
                    alert('Error saving session. Please try again.');
                };
                
            } catch (error) {
                console.error('Error saving session:', error);
                alert('Error saving session. Please try again.');
            }
        }
        
        // Load all saved sessions
        async function loadSessions() {
            if (!supportsIndexedDB || !db) return [];
            
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = (event) => {
                    const sessions = event.target.result;
                    displaySessions(sessions);
                    resolve(sessions);
                };
                
                request.onerror = (event) => {
                    console.error('Error loading sessions:', event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // Display sessions in modal
        function displaySessions(sessions) {
            const sessionList = document.getElementById('sessionList');
            
            if (!sessions || sessions.length === 0) {
                sessionList.innerHTML = '<div class="empty-sessions">No saved sessions yet.</div>';
                return;
            }
            
            // Sort by date (newest first)
            sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sessionList.innerHTML = sessions.map(session => `
                <div class="session-item">
                    <div class="session-info">
                        <div class="session-name">${session.name}</div>
                        <div class="session-date">${new Date(session.date).toLocaleString()}</div>
                    </div>
                    <div class="session-actions">
                        <button class="load-session-btn" onclick="loadSession('${session.id}')">Load</button>
                        <button class="delete-session-btn" onclick="deleteSession('${session.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Load a specific session
        async function loadSession(sessionId) {
            if (!supportsIndexedDB || !db) return;
            
            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(sessionId);
                
                request.onsuccess = (event) => {
                    const session = event.target.result;
                    if (!session) return;
                    
                    // Restore data
                    const data = session.data;
                    
                    // Restore X and Y data
                    xData = data.xData || [];
                    yData = data.yData || [];
                    
                    // Restore function and constraints
                    document.getElementById('funcInput').value = data.funcInput || '';
                    document.getElementById('constraints').value = data.constraints || '';
                    
                    // Restore parameters
                    if (data.parameters) {
                        for (let i = 1; i <= 10; i++) {
                            document.getElementById('c' + i).value = data.parameters['c' + i] || '1.0';
                        }
                    }
                    
                    // Restore grid cells
                    if (data.gridCells) {
                        for (let i = 0; i < Math.min(dataCells.length, data.gridCells.length); i++) {
                            dataCells[i].x.textContent = data.gridCells[i].x;
                            dataCells[i].y.textContent = data.gridCells[i].y;
                            
                            if (data.gridCells[i].x) {
                                dataCells[i].x.classList.remove('empty');
                            } else {
                                dataCells[i].x.classList.add('empty');
                            }
                            
                            if (data.gridCells[i].y) {
                                dataCells[i].y.classList.remove('empty');
                            } else {
                                dataCells[i].y.classList.add('empty');
                            }
                        }
                    }
                    
                    // Restore regression results if they exist
                    if (data.results) {
                        currentRegressionResults = data.results;
                        // You might want to re-run the regression or just display stored results
                    }
                    
                    // Update UI
                    parseDataFromGrid();
                    updatePlot();
                    checkFunctionAndUpdate();
                    
                    // Close modal
                    closeSessionModal();
                    
                    // Show success message
                    showCopyNotification(`Session "${session.name}" loaded successfully!`);
                };
                
                request.onerror = (event) => {
                    console.error('Error loading session:', event.target.error);
                    alert('Error loading session. Please try again.');
                };
                
            } catch (error) {
                console.error('Error loading session:', error);
                alert('Error loading session. Please try again.');
            }
        }
        
        // Delete a session
        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) return;
            
            if (!supportsIndexedDB || !db) return;
            
            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(sessionId);
                
                request.onsuccess = () => {
                    console.log('Session deleted:', sessionId);
                    loadSessions(); // Refresh list
                    showCopyNotification('Session deleted successfully!');
                };
                
                request.onerror = (event) => {
                    console.error('Error deleting session:', event.target.error);
                    alert('Error deleting session. Please try again.');
                };
                
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('Error deleting session. Please try again.');
            }
        }
        
        // Open session modal
        function openSessionModal() {
            if (!supportsIndexedDB) {
                alert('Session management requires IndexedDB support. Your browser may not support this feature.');
                return;
            }
            
            document.getElementById('sessionModal').style.display = 'block';
            loadSessions();
        }
        
        // Close session modal
        function closeSessionModal() {
            document.getElementById('sessionModal').style.display = 'none';
        }
        
        // Save current session
        function saveCurrentSession() {
            const sessionName = document.getElementById('sessionNameInput').value.trim();
            if (sessionName) {
                saveSession(sessionName);
            }
        }
        
        // PWA Installation
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            
            // Show install button
            const installButton = document.getElementById('installButton');
            installButton.style.display = 'flex';
            
            installButton.addEventListener('click', () => {
                // Show the install prompt
                deferredPrompt.prompt();
                
                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        installButton.style.display = 'none';
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
            });
        });
        
        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            document.getElementById('installButton').style.display = 'none';
            
            // Show save button since PWA is installed
            if (supportsIndexedDB) {
                document.getElementById('saveButton').style.display = 'flex';
            }
        });
        
        // Online/Offline detection
        function updateOnlineStatus() {
            const offlineIndicator = document.getElementById('offlineIndicator');
            const appStatus = document.getElementById('appStatus');
            
            if (navigator.onLine) {
                offlineIndicator.classList.remove('show');
                appStatus.textContent = isPWAInstalled() ? 'PWA ¬∑ Online' : 'Online';
            } else {
                offlineIndicator.classList.add('show');
                appStatus.textContent = isPWAInstalled() ? 'PWA ¬∑ Offline' : 'Offline';
            }
        }
        
        // Initialize everything
        async function initializeApp() {
            // Check if PWA is installed
            const isInstalled = isPWAInstalled();
            
            // Update UI based on installation status
            if (isInstalled && supportsIndexedDB) {
                document.getElementById('saveButton').style.display = 'flex';
                document.getElementById('appStatus').textContent = 'PWA Installed';
            }
            
            // Initialize IndexedDB if supported
            if (supportsIndexedDB) {
                try {
                    await initIndexedDB();
                    console.log('IndexedDB initialized successfully');
                } catch (error) {
                    console.warn('IndexedDB initialization failed:', error);
                }
            }
            
            // Set up online/offline listeners
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                const modal = document.getElementById('sessionModal');
                if (event.target === modal) {
                    closeSessionModal();
                }
            });
        }
        
        // === EXISTING REGRESSION CODE (ALL YOUR ORIGINAL FUNCTIONS) ===
        // All your existing JavaScript code remains exactly the same here
        // Only the variable declarations at the top need to be kept:
        
        let xData = [];
        let yData = [];
        let usedParams = [];
        let dataCells = [];
        let plotUpdateTimeout = null;
        let functionUpdateTimeout = null;
        let paramUpdateTimeout = null;
        let lastFunctionHash = '';
        let lastParamsHash = '';
        let lastDataHash = '';
        let currentRegressionResults = null;
        
        // Initialize data grid
        function initializeDataGrid() {
            // ... (all your existing initializeDataGrid code)
            const grid = document.getElementById('dataGrid');
            grid.innerHTML = '';
            
            // Create 2 columns with 20 initial rows
            const xColumn = document.createElement('div');
            xColumn.className = 'data-column';
            
            const yColumn = document.createElement('div');
            yColumn.className = 'data-column';
            
            dataCells = [];
            
            for (let i = 0; i < 20; i++) {
                const xCell = document.createElement('div');
                xCell.className = 'data-cell empty';
                xCell.contentEditable = 'true';
                xCell.dataset.row = i;
                xCell.dataset.col = 'x';
                xCell.addEventListener('input', handleCellInput);
                xCell.addEventListener('keydown', handleCellKeydown);
                xCell.addEventListener('paste', handlePaste);
                xCell.addEventListener('blur', scheduleDataUpdate);
                xColumn.appendChild(xCell);
                
                const yCell = document.createElement('div');
                yCell.className = 'data-cell empty';
                yCell.contentEditable = 'true';
                yCell.dataset.row = i;
                yCell.dataset.col = 'y';
                yCell.addEventListener('input', handleCellInput);
                yCell.addEventListener('keydown', handleCellKeydown);
                yCell.addEventListener('paste', handlePaste);
                yCell.addEventListener('blur', scheduleDataUpdate);
                yColumn.appendChild(yCell);
                
                dataCells.push({x: xCell, y: yCell});
            }
            
            grid.appendChild(xColumn);
            grid.appendChild(yColumn);
            
            // Add event listeners for function input
            document.getElementById('funcInput').addEventListener('input', scheduleFunctionUpdate);
            
            // Add event listeners for parameter inputs
            for (let i = 1; i <= 10; i++) {
                document.getElementById('c' + i).addEventListener('input', scheduleParamUpdate);
            }
            
            // Add sample data
            setSampleData();
        }
        
        function setSampleData() {
            const sampleX = [1, 2, 3, 4, 5];
            const sampleY = [2.1, 4.3, 6.2, 8.1, 10.3];
            
            for (let i = 0; i < sampleX.length; i++) {
                dataCells[i].x.textContent = sampleX[i];
                dataCells[i].y.textContent = sampleY[i];
                dataCells[i].x.classList.remove('empty');
                dataCells[i].y.classList.remove('empty');
            }
            
            // Automatically plot the sample data
            setTimeout(() => {
                parseDataFromGrid();
                updatePlot();
            }, 100);
        }
        
        // ... (ALL YOUR EXISTING FUNCTIONS CONTINUE HERE EXACTLY AS THEY WERE)
        // handleCellInput, scheduleDataUpdate, handleCellKeydown, focusCell, handlePaste,
        // addRow, clearData, parseDataFromGrid, checkFunctionAndUpdate, calculatePlotRange,
        // updatePlot, jacobian, identifyUsedParams, evaluateFunction, convertFunction,
        // getInitialParams, parseConstraints, checkConstraints, residuals, matrixMultiply,
        // transpose, invertMatrix, calculateCovarianceMatrix, calculateTStatistic,
        // calculatePValue, levenbergMarquardt, calculateAllStatistics, displayParameterStats,
        // showCopyNotification, copyToClipboard, formatForExcel, generateExportTables,
        // copyAllResults, copyGoodnessOfFit, copyParameterStats, copyRegressionEquation,
        // runRegression
        
        // I've omitted the full code for brevity, but ALL your existing functions
        // should be included here exactly as they were in your original file.
        
        // The only changes needed are adding the PWA initialization at the end:
        
        // Initialize grid on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeDataGrid();
            initializeApp(); // Initialize PWA features
        });
    </script>
</body>
</html>
