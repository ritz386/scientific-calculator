<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonlinear Regression Analysis</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-size: 22px;
        }
        
        /* Desktop Layout - All in one row */
        .main-grid {
            display: grid;
            grid-template-columns: 20% 30% 50%;
            gap: 12px;
            margin-bottom: 15px;
            align-items: stretch;
        }
        
        /* Mobile Layout - First two in row 1, graph in row 2 */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 10px;
            }
            
            .container {
                padding: 10px;
            }
            
            body {
                padding: 5px;
            }
            
            h1 {
                font-size: 18px;
                margin-bottom: 10px;
            }
        }
        
        .section {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .section h2 {
            color: #333;
            font-size: 15px;
            margin-bottom: 10px;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
        }
        
        .data-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }
        
        .data-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            font-weight: bold;
            color: #333;
            padding: 0 6px;
            font-size: 13px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            flex: 1;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .data-column {
            display: flex;
            flex-direction: column;
        }
        
        .data-cell {
            padding: 5px 6px;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            min-height: 30px;
            outline: none;
            background: white;
        }
        
        .data-cell:focus {
            background: #f8f8f8;
            outline: 2px solid #000;
            z-index: 1;
            position: relative;
        }
        
        .data-cell.empty {
            color: #999;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 3px;
            color: #333;
            font-size: 13px;
        }
        
        input[type="text"] {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .param-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-top: 6px;
        }
        
        .param-input {
            display: flex;
            flex-direction: column;
        }
        
        .param-input label {
            font-size: 10px;
            text-align: center;
            margin-bottom: 2px;
        }
        
        .param-input input {
            padding: 5px;
            font-size: 11px;
            text-align: center;
            width: 100%;
        }
        
        button {
            background: #000;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 6px;
        }
        
        button:hover {
            background: #333;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .plot-container {
            width: 100%;
            height: 100%;
            min-height: 400px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
        }
        
        @media (max-width: 768px) {
            .plot-container {
                min-height: 350px;
            }
        }
        
        .results {
            background: #fff;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            margin-top: 12px;
        }
        
        .results h2 {
            color: #000;
            margin-bottom: 10px;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        @media (max-width: 1024px) {
            .results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .result-item {
            background: #fff;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .result-label {
            font-size: 10px;
            color: #666;
            font-weight: 600;
        }
        
        .result-value {
            font-size: 13px;
            color: #000;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        .stats-row {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .stats-row {
                gap: 8px;
            }
        }
        
        .stat-box {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            flex: 1;
            min-width: 140px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }
        
        .stat-value {
            font-size: 18px;
            color: #000;
            font-weight: bold;
        }
        
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 6px;
            border-radius: 4px;
            margin-top: 6px;
            border-left: 4px solid #d32f2f;
            font-size: 12px;
        }
        
        .info {
            color: #000;
            background: #f5f5f5;
            padding: 6px;
            border-radius: 4px;
            margin-top: 6px;
            border-left: 4px solid #000;
            font-size: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .data-controls {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }
        
        .data-controls button {
            padding: 5px 10px;
            font-size: 12px;
            background: #000;
        }
        
        .data-controls button:last-child {
            background: #000;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            padding: 3px 6px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .point-count {
            color: #333;
            font-weight: 600;
        }
        
        .plot-status {
            color: #000;
            font-weight: 600;
        }
        
        .param-input input:focus {
            border-color: #000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
            outline: none;
        }
        
        .function-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            padding: 3px 6px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .function-valid {
            color: #000;
            font-weight: 600;
        }
        
        .function-invalid {
            color: #d32f2f;
            font-weight: 600;
        }
        
        .param-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 11px;
        }
        
        .param-table th {
            background: #f5f5f5;
            padding: 6px;
            border: 1px solid #ddd;
            text-align: center;
            font-weight: 600;
            color: #000;
        }
        
        .param-table td {
            padding: 6px;
            border: 1px solid #ddd;
            text-align: center;
            background: white;
        }
        
        .param-table .param-name {
            font-weight: 600;
            color: #000;
        }
        
        .param-table .sig-star {
            color: #d32f2f;
            font-weight: bold;
        }
        
        .advanced-stats {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #ddd;
        }
        
        .advanced-stats h3 {
            color: #000;
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .export-section {
            margin-top: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 2px solid #ddd;
        }
        
        .export-section h3 {
            color: #000;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 15px;
        }
        
        .export-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 11px;
            background: white;
        }
        
        .export-table th {
            background: #f5f5f5;
            padding: 6px;
            border: 1px solid #ddd;
            text-align: left;
            font-weight: 600;
            color: #000;
        }
        
        .export-table td {
            padding: 6px;
            border: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
        }
        
        .export-table .category {
            background: #f9f9f9;
            font-weight: 600;
            color: #000;
        }
        
        .copy-buttons {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .copy-button {
            background: #000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .copy-button:hover {
            background: #333;
        }
        
        .copy-button.success {
            background: #000;
        }
        
        .copy-notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #000;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        .compact-section {
            margin-top: 12px;
            padding: 10px;
            background: #fff;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .compact-section h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 6px;
            border-bottom: 2px solid #000;
            padding-bottom: 3px;
        }
        
        .compact-param-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .run-regression-btn {
            background: #000;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
            width: 100%;
        }
        
        .run-regression-btn:hover {
            background: #333;
        }
        
        .compact-param-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 5px;
        }
        
        @media (max-width: 1024px) {
            .compact-param-grid,
            .param-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .compact-param-grid,
            .param-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .compact-param-grid,
            .param-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        small {
            color: #666;
            margin-top: 3px;
            font-size: 11px;
        }
        
        /* Make sure plot container takes full height */
        .plot-section {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .plot-section h2 {
            color: #333;
            font-size: 15px;
            margin-bottom: 10px;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
        }

        .ga-settings {
            margin-top: 10px;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .ga-settings h4 {
            font-size: 12px;
            color: #333;
            margin-bottom: 6px;
        }

        .ga-params {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        @media (max-width: 768px) {
            .ga-params {
                grid-template-columns: 1fr;
            }
        }

        .ga-param {
            display: flex;
            flex-direction: column;
        }

        .ga-param label {
            font-size: 10px;
            margin-bottom: 2px;
        }

        .ga-param input {
            padding: 4px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nonlinear Regression Analysis (Genetic Algorithm)</h1>
        
        <div class="main-grid">
            <!-- 1. Input Data (X and Y) - 20% width -->
            <div class="section">
                <h2>1. Input Data (X and Y)</h2>
                
                <div class="data-input-container">
                    <div class="data-header">
                        <div>X Data</div>
                        <div>Y Data</div>
                    </div>
                    
                    <div class="data-grid" id="dataGrid">
                        <!-- Data cells will be generated here -->
                    </div>
                    
                    <div class="data-controls">
                        <button onclick="addRow()">Add Row</button>
                        <button onclick="clearData()">Clear All</button>
                    </div>
                </div>
                
                <div class="status-bar">
                    <div class="point-count">Data Points: <span id="pointCount">0</span></div>
                    <div class="plot-status" id="plotStatus">No data plotted</div>
                </div>
                <div id="dataError"></div>
            </div>
            
            <!-- 2. Function Definition - 30% width -->
            <div class="section">
                <h2>2. Function Definition</h2>
                <div class="input-group">
                    <label for="funcInput">Function (use x, c1, c2, ... c10):</label>
                    <input type="text" id="funcInput" placeholder="c1*x^2 + c2*x + c3" value="c1*x^2 + c2*x + c3">
                    <small>Supported: +, -, *, /, ^, exp(), log(), sin(), cos(), sqrt(), etc.</small>
                </div>
                
                <div class="input-group" style="margin-top: 10px;">
                    <label for="constraints">Constraints (optional):</label>
                    <input type="text" id="constraints" placeholder="c1>0, c2<10, c3>=0">
                    <small>Format: c1>0, c2<10, c3>=0, etc.</small>
                </div>
                
                <div class="function-status" id="functionStatus">
                    <div>Function Status:</div>
                    <div class="function-valid" id="functionValidStatus">Ready</div>
                </div>

                <div class="ga-settings">
                    <h4>GA Settings (Optional)</h4>
                    <div class="ga-params">
                        <div class="ga-param">
                            <label>Population:</label>
                            <input type="number" id="populationSize" value="100" min="20" max="500">
                        </div>
                        <div class="ga-param">
                            <label>Generations:</label>
                            <input type="number" id="generations" value="500" min="50" max="2000">
                        </div>
                        <div class="ga-param">
                            <label>Mutation Rate:</label>
                            <input type="number" id="mutationRate" value="0.1" min="0.01" max="0.5" step="0.01">
                        </div>
                    </div>
                </div>
                
                <div class="compact-section">
                    <h3>3. Parameter Bounds (for GA)</h3>
                    <small>Leave empty for auto bounds based on data</small>
                    <div class="compact-param-grid" style="margin-top: 6px;">
                        <div class="param-input">
                            <label>c1 min:</label>
                            <input type="text" id="c1_min" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c1 max:</label>
                            <input type="text" id="c1_max" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c2 min:</label>
                            <input type="text" id="c2_min" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c2 max:</label>
                            <input type="text" id="c2_max" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c3 min:</label>
                            <input type="text" id="c3_min" placeholder="auto">
                        </div>
                    </div>
                    
                    <div class="compact-param-grid">
                        <div class="param-input">
                            <label>c3 max:</label>
                            <input type="text" id="c3_max" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c4 min:</label>
                            <input type="text" id="c4_min" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c4 max:</label>
                            <input type="text" id="c4_max" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c5 min:</label>
                            <input type="text" id="c5_min" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c5 max:</label>
                            <input type="text" id="c5_max" placeholder="auto">
                        </div>
                    </div>

                    <div class="compact-param-grid">
                        <div class="param-input">
                            <label>c6 min:</label>
                            <input type="text" id="c6_min" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c6 max:</label>
                            <input type="text" id="c6_max" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c7 min:</label>
                            <input type="text" id="c7_min" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c7 max:</label>
                            <input type="text" id="c7_max" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c8 min:</label>
                            <input type="text" id="c8_min" placeholder="auto">
                        </div>
                    </div>

                    <div class="compact-param-grid">
                        <div class="param-input">
                            <label>c8 max:</label>
                            <input type="text" id="c8_max" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c9 min:</label>
                            <input type="text" id="c9_min" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c9 max:</label>
                            <input type="text" id="c9_max" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c10 min:</label>
                            <input type="text" id="c10_min" placeholder="auto">
                        </div>
                        <div class="param-input">
                            <label>c10 max:</label>
                            <input type="text" id="c10_max" placeholder="auto">
                        </div>
                    </div>
                    
                    <button class="run-regression-btn" onclick="runRegression()">Run Regression</button>
                    <div id="functionError"></div>
                </div>
            </div>
            
            <!-- 3. Data with initial function fit - 50% width -->
            <div class="section plot-section">
                <h2>3. Data Visualization</h2>
                <div class="plot-container" id="plotDiv"></div>
            </div>
        </div>
        
        <div id="resultsSection" style="display: none;">
            <div class="results">
                <h2>Optimized Parameters</h2>
                <div class="results-grid" id="optimizedParams"></div>
                
                <h2 style="margin-top: 12px;">Goodness of Fit</h2>
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">R (Correlation)</div>
                        <div class="stat-value" id="rValue">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">RÂ² (R-squared)</div>
                        <div class="stat-value" id="r2Value">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Adjusted RÂ²</div>
                        <div class="stat-value" id="adjR2Value">-</div>
                    </div>
                </div>
                
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">RMSE</div>
                        <div class="stat-value" id="rmseValue">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">MAE</div>
                        <div class="stat-value" id="maeValue">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">AIC</div>
                        <div class="stat-value" id="aicValue">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">F-Statistic</div>
                        <div class="stat-value" id="fStatValue">-</div>
                    </div>
                </div>
                
                <div class="export-section">
                    <h3>
                        <span>ðŸ“‹ Export Results to Excel</span>
                    </h3>
                    <p style="color: #666; margin-bottom: 10px; font-size: 12px;">
                        Copy the tables below and paste directly into Excel.
