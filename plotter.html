<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Multi-Plot Data Plotter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            min-height: calc(100vh - 160px);
        }
        
        .panel {
            overflow-y: auto;
            transition: all 0.3s;
        }
        
        .panel.collapsed {
            grid-template-columns: 0;
            width: 0;
            overflow: hidden;
        }
        
        .left-panel {
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
        }
        
        .middle-panel {
            background: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .right-panel {
            background: #f8f9fa;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #667eea;
        }
        
        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
        }
        
        .collapse-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            color: #667eea;
            transition: transform 0.3s;
        }
        
        .collapse-btn:hover {
            transform: scale(1.2);
        }
        
        .expand-tab {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            padding: 40px 8px;
            cursor: pointer;
            border-radius: 0 8px 8px 0;
            font-size: 12px;
            font-weight: 600;
            writing-mode: vertical-rl;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .expand-tab:hover {
            padding-right: 12px;
            background: #764ba2;
        }
        
        .expand-tab.left {
            left: 0;
        }
        
        .expand-tab.right {
            right: 0;
            border-radius: 8px 0 0 8px;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 10px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        button.primary {
            background: #667eea;
            color: white;
        }
        
        button.success {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        button.success:hover {
            background: #218838;
            border-color: #218838;
        }
        
        button.danger {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        button.danger:hover {
            background: #c82333;
            border-color: #c82333;
        }
        
        .full-width {
            width: 100%;
        }
        
        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }
        
        input[type="text"],
        input[type="color"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 12px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input[type="color"] {
            height: 38px;
            cursor: pointer;
        }
        
        .input-group {
            margin-bottom: 14px;
        }
        
        .info-text {
            font-size: 11px;
            color: #666;
            margin-top: 6px;
            font-style: italic;
        }
        
        #plotDiv {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            min-height: 500px;
            position: relative;
            transition: all 0.3s;
        }
        
        .trace-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        
        .trace-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .trace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .trace-name {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        
        .trace-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
        }
        
        .trace-info {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .trace-actions {
            display: flex;
            gap: 6px;
        }
        
        .trace-actions button {
            padding: 6px 10px;
            font-size: 11px;
        }
        
        .add-trace-form {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .form-title {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 14px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .button-grid button {
            padding: 8px;
            font-size: 11px;
        }
        
        .plot-controls {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            max-height: 700px;
            overflow-y: auto;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
            font-size: 12px;
        }
        
        .edit-panel-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 380px;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .edit-panel-overlay.active {
            transform: translateX(0);
        }
        
        .edit-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .edit-panel-title {
            font-size: 16px;
            font-weight: 700;
        }
        
        .edit-panel-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .edit-panel-close:hover {
            background: rgba(255,255,255,0.3);
            transform: none;
        }
        
        .edit-panel-content {
            padding: 20px;
        }
        
        .edit-panel-stack {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 999;
        }
        
        .edit-panel-stack .edit-panel-overlay {
            pointer-events: all;
        }

        /* Style Preview Box */
        .style-preview {
            width: 100%;
            height: 80px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }
        
        .preview-scatter {
            display: flex;
            gap: 20px;
        }
        
        .preview-scatter div {
            transition: all 0.3s;
        }
        
        .preview-line {
            width: 80%;
            height: 4px;
            position: relative;
        }
        
        .preview-bar {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            height: 60px;
        }
        
        .preview-bar div {
            width: 20px;
            transition: all 0.3s;
        }
        
        .range-value {
            display: inline-block;
            min-width: 30px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
        }

        /* New Axis Controls Styles */
        .axis-controls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
        }
        
        .axis-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
        }
        
        .axis-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .axis-section-title::before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .x-axis-title::before {
            background: #667eea;
        }
        
        .y-axis-title::before {
            background: #764ba2;
        }
        
        .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .toggle-label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #667eea;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .range-inputs input {
            text-align: center;
        }
        
        .font-controls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .font-sample {
            grid-column: span 2;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            background: white;
            margin-top: 8px;
        }
        
        .advanced-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .control-header .form-title {
            margin-bottom: 0;
        }
        
        .reset-btn {
            padding: 6px 12px;
            font-size: 11px;
        }
        
        /* Legend and Text Box Controls */
        .legend-textbox-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .legend-controls, .textbox-controls, .frame-border-controls {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .position-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .position-buttons button {
            padding: 6px;
            font-size: 11px;
        }
        
        .textbox-list {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .textbox-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .textbox-item:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        
        .textbox-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .textbox-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .textbox-name {
            font-weight: 600;
            font-size: 12px;
            color: #333;
        }
        
        .textbox-preview {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .textbox-actions {
            display: flex;
            gap: 4px;
            margin-top: 6px;
        }
        
        .textbox-actions button {
            padding: 4px 8px;
            font-size: 10px;
        }
        
        .color-with-opacity {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
        }
        
        .opacity-slider {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .opacity-slider input {
            flex: 1;
        }
        
        .opacity-value {
            min-width: 30px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #667eea;
        }
        
        .move-controls {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .move-controls button {
            flex: 1;
            padding: 6px;
            font-size: 11px;
        }
        
        .legend-preview {
            width: 100%;
            height: 60px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
        }
        
        .textbox-preview-box {
            width: 100%;
            height: 60px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
            padding: 10px;
            text-align: center;
        }
        
        .draggable-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            color: #666;
            background: rgba(255,255,255,0.8);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* Frame and Border Controls */
        .dimension-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .unit-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .unit-selector button {
            flex: 1;
            padding: 6px;
            font-size: 11px;
        }
        
        .aspect-ratio-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        
        .aspect-ratio-control label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .frame-sides {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .frame-side {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
        }
        
        .frame-side-title {
            font-size: 12px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .frame-side-title::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        
        .left-side::before { background: #667eea; }
        .right-side::before { background: #764ba2; }
        .bottom-side::before { background: #43e97b; }
        .top-side::before { background: #fa709a; }
        
        .border-preview {
            width: 100%;
            height: 80px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .preview-inner-frame {
            width: 70%;
            height: 50%;
            border: 2px solid #333;
            position: relative;
        }
        
        .border-style-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .border-effect-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }
        
        .border-effect {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .border-effect input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        
        .border-effect label {
            margin-bottom: 0;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .reset-all-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Multi-Trace Data Plotter</h1>
            <p>Paste your data once, then add unlimited traces to your plot</p>
        </div>
        
        <div class="main" id="mainContainer">
            <!-- Left Panel: Data Input -->
            <div class="panel left-panel" id="leftPanel">
                <div class="panel-header">
                    <div class="panel-title">ðŸ“‹ Data Input</div>
                    <button class="collapse-btn" onclick="togglePanel('left')">â—€</button>
                </div>
                
                <div class="input-group">
                    <label>Paste Your Data:</label>
                    <textarea id="dataInput" placeholder="Paste tab or comma-separated data&#10;Example:&#10;Time  Temp1  Temp2  Humidity&#10;0     20     22     45&#10;1     21     23     46&#10;2     22     24     47"></textarea>
                    <p class="info-text">First row = headers. All columns will be available for plotting.</p>
                </div>
                
                <button onclick="parseDataInput()" class="full-width primary">
                    âœ“ Load Data
                </button>
                
                <div id="dataInfo" style="margin-top: 16px; font-size: 12px; color: #666;"></div>
            </div>
            
            <!-- Middle Panel: Plot Display -->
            <div class="panel middle-panel">
                <div class="plot-controls">
                    <div class="input-group">
                        <label for="plotTitle">Plot Title:</label>
                        <input type="text" id="plotTitle" value="Multi-Trace Plot" onchange="updatePlot()">
                    </div>
                    
                    <!-- Plot Frame & Borders Controls -->
                    <div class="frame-border-controls">
                        <div class="control-header">
                            <div class="form-title" style="font-size: 13px;">Plot Frame & Borders</div>
                        </div>
                        
                        <div class="dimension-controls">
                            <div class="input-group">
                                <label>Plot Width:</label>
                                <div class="unit-selector">
                                    <button id="widthPx" class="primary" onclick="setDimensionUnit('width', 'px')">PX</button>
                                    <button id="widthCm" onclick="setDimensionUnit('width', 'cm')">CM</button>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="plotWidth" value="800" min="100" max="5000" step="10" onchange="updatePlotDimensions()">
                                    <input type="text" id="plotWidthUnit" value="px" readonly style="width: 50px; text-align: center;">
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="autoWidth" checked onchange="toggleAutoDimension('width')">
                                    <label for="autoWidth">Auto Width</label>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label>Plot Height:</label>
                                <div class="unit-selector">
                                    <button id="heightPx" class="primary" onclick="setDimensionUnit('height', 'px')">PX</button>
                                    <button id="heightCm" onclick="setDimensionUnit('height', 'cm')">CM</button>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="plotHeight" value="600" min="100" max="5000" step="10" onchange="updatePlotDimensions()">
                                    <input type="text" id="plotHeightUnit" value="px" readonly style="width: 50px; text-align: center;">
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="autoHeight" checked onchange="toggleAutoDimension('height')">
                                    <label for="autoHeight">Auto Height</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="aspect-ratio-control">
                            <input type="checkbox" id="lockAspectRatio" onchange="toggleAspectRatioLock()">
                            <label for="lockAspectRatio">Lock Aspect Ratio (Width:Height = 4:3)</label>
                        </div>
                        
                        <div class="border-preview" id="borderPreview">
                            <div class="preview-inner-frame" id="innerFramePreview"></div>
                        </div>
                        
                        <div class="frame-sides">
                            <div class="frame-side">
                                <div class="frame-side-title left-side">Left Axis</div>
                                <div class="toggle-group">
                                    <span class="toggle-label">Show:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="showLeftAxis" checked onchange="updatePlot()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>Color:</label>
                                    <input type="color" id="leftAxisColor" value="#000000" onchange="updatePlot()">
                                </div>
                                <div class="input-group">
                                    <label>Thickness: <span class="range-value" id="leftAxisThicknessValue">2</span>px</label>
                                    <input type="range" id="leftAxisThickness" min="1" max="10" value="2" 
                                        oninput="document.getElementById('leftAxisThicknessValue').textContent = this.value; updatePlot()"
                                        style="width: 100%; cursor: pointer;">
                                </div>
                            </div>
                            
                            <div class="frame-side">
                                <div class="frame-side-title right-side">Right Axis</div>
                                <div class="toggle-group">
                                    <span class="toggle-label">Show:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="showRightAxis" onchange="updatePlot()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>Color:</label>
                                    <input type="color" id="rightAxisColor" value="#000000" onchange="updatePlot()">
                                </div>
                                <div class="input-group">
                                    <label>Thickness: <span class="range-value" id="rightAxisThicknessValue">2</span>px</label>
                                    <input type="range" id="rightAxisThickness" min="1" max="10" value="2" 
                                        oninput="document.getElementById('rightAxisThicknessValue').textContent = this.value; updatePlot()"
                                        style="width: 100%; cursor: pointer;">
                                </div>
                            </div>
                            
                            <div class="frame-side">
                                <div class="frame-side-title bottom-side">Bottom Axis</div>
                                <div class="toggle-group">
                                    <span class="toggle-label">Show:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="showBottomAxis" checked onchange="updatePlot()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>Color:</label>
                                    <input type="color" id="bottomAxisColor" value="#000000" onchange="updatePlot()">
                                </div>
                                <div class="input-group">
                                    <label>Thickness: <span class="range-value" id="bottomAxisThicknessValue">2</span>px</label>
                                    <input type="range" id="bottomAxisThickness" min="1" max="10" value="2" 
                                        oninput="document.getElementById('bottomAxisThicknessValue').textContent = this.value; updatePlot()"
                                        style="width: 100%; cursor: pointer;">
                                </div>
                            </div>
                            
                            <div class="frame-side">
                                <div class="frame-side-title top-side">Top Axis</div>
                                <div class="toggle-group">
                                    <span class="toggle-label">Show:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="showTopAxis" onchange="updatePlot()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="input-group">
                                    <label>Color:</label>
                                    <input type="color" id="topAxisColor" value="#000000" onchange="updatePlot()">
                                </div>
                                <div class="input-group">
                                    <label>Thickness: <span class="range-value" id="topAxisThicknessValue">2</span>px</label>
                                    <input type="range" id="topAxisThickness" min="1" max="10" value="2" 
                                        oninput="document.getElementById('topAxisThicknessValue').textContent = this.value; updatePlot()"
                                        style="width: 100%; cursor: pointer;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>Outer Plot Border:</label>
                            <div class="border-style-controls">
                                <div class="input-group">
                                    <label>Color:</label>
                                    <input type="color" id="outerBorderColor" value="#000000" onchange="updateOuterBorder()">
                                </div>
                                <div class="input-group">
                                    <label>Thickness: <span class="range-value" id="outerBorderThicknessValue">2</span>px</label>
                                    <input type="range" id="outerBorderThickness" min="1" max="20" value="2" 
                                        oninput="document.getElementById('outerBorderThicknessValue').textContent = this.value; updateOuterBorder()"
                                        style="width: 100%; cursor: pointer;">
                                </div>
                                <div class="input-group">
                                    <label>Style:</label>
                                    <select id="outerBorderStyle" onchange="updateOuterBorder()">
                                        <option value="solid">Solid</option>
                                        <option value="dashed">Dashed</option>
                                        <option value="dotted">Dotted</option>
                                        <option value="double">Double</option>
                                        <option value="groove">Groove</option>
                                        <option value="ridge">Ridge</option>
                                        <option value="inset">Inset</option>
                                        <option value="outset">Outset</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Radius: <span class="range-value" id="outerBorderRadiusValue">8</span>px</label>
                                    <input type="range" id="outerBorderRadius" min="0" max="50" value="8" 
                                        oninput="document.getElementById('outerBorderRadiusValue').textContent = this.value; updateOuterBorder()"
                                        style="width: 100%; cursor: pointer;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-effect-controls">
                            <div class="border-effect">
                                <input type="checkbox" id="showBorderShadow" onchange="updateOuterBorder()">
                                <label for="showBorderShadow">Shadow Effect</label>
                            </div>
                            <div class="border-effect">
                                <input type="checkbox" id="showInnerGlow" onchange="updateOuterBorder()">
                                <label for="showInnerGlow">Inner Glow</label>
                            </div>
                        </div>
                        
                        <button onclick="resetFrameBorders()" class="reset-all-btn">
                            ðŸ”„ Reset All Frame Settings
                        </button>
                    </div>
                    
                    <div class="axis-controls-grid">
                        <!-- X Axis Controls -->
                        <div class="axis-section">
                            <div class="axis-section-title x-axis-title">X-Axis Controls</div>
                            
                            <div class="input-group">
                                <label for="xAxisLabel">Label:</label>
                                <input type="text" id="xAxisLabel" value="X Axis" onchange="updatePlot()">
                            </div>
                            
                            <div class="toggle-group">
                                <span class="toggle-label">Manual Range:</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="xManualRange" onchange="toggleManualRange('x')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div id="xRangeControls" style="display: none;">
                                <div class="range-inputs">
                                    <input type="number" id="xMin" placeholder="Min" step="any" onchange="updatePlot()">
                                    <input type="number" id="xMax" placeholder="Max" step="any" onchange="updatePlot()">
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label for="xScaleType">Scale Type:</label>
                                <select id="xScaleType" onchange="updatePlot()">
                                    <option value="linear">Linear</option>
                                    <option value="log10">Log10 (Base 10)</option>
                                    <option value="loge">Natural Log (ln)</option>
                                    <option value="log2">Log2 (Base 2)</option>
                                    <option value="log">Custom Base</option>
                                </select>
                            </div>
                            
                            <div id="xCustomBase" style="display: none;">
                                <input type="number" id="xLogBase" placeholder="Base" min="1" step="any" value="10" onchange="updatePlot()">
                            </div>
                            
                            <div class="advanced-controls">
                                <div class="control-header">
                                    <div class="form-title" style="font-size: 13px;">Ticks & Font</div>
                                </div>
                                
                                <div class="toggle-group">
                                    <span class="toggle-label">Show Major Ticks:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="xShowMajorTicks" checked onchange="updatePlot()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="input-group">
                                    <label for="xMajorInterval">Major Tick Interval:</label>
                                    <input type="number" id="xMajorInterval" value="1" step="any" onchange="updatePlot()">
                                </div>
                                
                                <div class="toggle-group">
                                    <span class="toggle-label">Show Minor Ticks:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="xShowMinorTicks" checked onchange="updatePlot()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="input-group">
                                    <label for="xMinorTicks">Minor Ticks per Interval:</label>
                                    <input type="number" id="xMinorTicks" value="10" min="0" max="20" onchange="updatePlot()">
                                </div>
                                
                                <div class="font-controls-grid">
                                    <div class="input-group">
                                        <label for="xLabelFont">Label Font:</label>
                                        <select id="xLabelFont" onchange="updatePlot()">
                                            <option value="Arial">Arial</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Palatino">Palatino</option>
                                            <option value="Garamond">Garamond</option>
                                            <option value="Tahoma">Tahoma</option>
                                            <option value="Calibri">Calibri</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="xLabelSize">Label Size:</label>
                                        <input type="number" id="xLabelSize" value="14" min="8" max="36" onchange="updatePlot()">
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="xTickFont">Tick Font:</label>
                                        <select id="xTickFont" onchange="updatePlot()">
                                            <option value="Arial">Arial</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Palatino">Palatino</option>
                                            <option value="Garamond">Garamond</option>
                                            <option value="Tahoma">Tahoma</option>
                                            <option value="Calibri">Calibri</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="xTickSize">Tick Size:</label>
                                        <input type="number" id="xTickSize" value="12" min="8" max="24" onchange="updatePlot()">
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="xLabelWeight">Label Weight:</label>
                                        <select id="xLabelWeight" onchange="updatePlot()">
                                            <option value="normal">Normal</option>
                                            <option value="bold">Bold</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="xLabelItalic">Italic:</label>
                                        <select id="xLabelItalic" onchange="updatePlot()">
                                            <option value="normal">No</option>
                                            <option value="italic">Yes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Y Axis Controls -->
                        <div class="axis-section">
                            <div class="axis-section-title y-axis-title">Y-Axis Controls</div>
                            
                            <div class="input-group">
                                <label for="yAxisLabel">Label:</label>
                                <input type="text" id="yAxisLabel" value="Y Axis" onchange="updatePlot()">
                            </div>
                            
                            <div class="toggle-group">
                                <span class="toggle-label">Manual Range:</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="yManualRange" onchange="toggleManualRange('y')">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div id="yRangeControls" style="display: none;">
                                <div class="range-inputs">
                                    <input type="number" id="yMin" placeholder="Min" step="any" onchange="updatePlot()">
                                    <input type="number" id="yMax" placeholder="Max" step="any" onchange="updatePlot()">
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label for="yScaleType">Scale Type:</label>
                                <select id="yScaleType" onchange="updatePlot()">
                                    <option value="linear">Linear</option>
                                    <option value="log10">Log10 (Base 10)</option>
                                    <option value="loge">Natural Log (ln)</option>
                                    <option value="log2">Log2 (Base 2)</option>
                                    <option value="log">Custom Base</option>
                                </select>
                            </div>
                            
                            <div id="yCustomBase" style="display: none;">
                                <input type="number" id="yLogBase" placeholder="Base" min="1" step="any" value="10" onchange="updatePlot()">
                            </div>
                            
                            <div class="advanced-controls">
                                <div class="control-header">
                                    <div class="form-title" style="font-size: 13px;">Ticks & Font</div>
                                </div>
                                
                                <div class="toggle-group">
                                    <span class="toggle-label">Show Major Ticks:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="yShowMajorTicks" checked onchange="updatePlot()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="input-group">
                                    <label for="yMajorInterval">Major Tick Interval:</label>
                                    <input type="number" id="yMajorInterval" value="1" step="any" onchange="updatePlot()">
                                </div>
                                
                                <div class="toggle-group">
                                    <span class="toggle-label">Show Minor Ticks:</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="yShowMinorTicks" checked onchange="updatePlot()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                
                                <div class="input-group">
                                    <label for="yMinorTicks">Minor Ticks per Interval:</label>
                                    <input type="number" id="yMinorTicks" value="10" min="0" max="20" onchange="updatePlot()">
                                </div>
                                
                                <div class="font-controls-grid">
                                    <div class="input-group">
                                        <label for="yLabelFont">Label Font:</label>
                                        <select id="yLabelFont" onchange="updatePlot()">
                                            <option value="Arial">Arial</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Palatino">Palatino</option>
                                            <option value="Garamond">Garamond</option>
                                            <option value="Tahoma">Tahoma</option>
                                            <option value="Calibri">Calibri</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="yLabelSize">Label Size:</label>
                                        <input type="number" id="yLabelSize" value="14" min="8" max="36" onchange="updatePlot()">
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="yTickFont">Tick Font:</label>
                                        <select id="yTickFont" onchange="updatePlot()">
                                            <option value="Arial">Arial</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Palatino">Palatino</option>
                                            <option value="Garamond">Garamond</option>
                                            <option value="Tahoma">Tahoma</option>
                                            <option value="Calibri">Calibri</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="yTickSize">Tick Size:</label>
                                        <input type="number" id="yTickSize" value="12" min="8" max="24" onchange="updatePlot()">
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="yLabelWeight">Label Weight:</label>
                                        <select id="yLabelWeight" onchange="updatePlot()">
                                            <option value="normal">Normal</option>
                                            <option value="bold">Bold</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label for="yLabelItalic">Italic:</label>
                                        <select id="yLabelItalic" onchange="updatePlot()">
                                            <option value="normal">No</option>
                                            <option value="italic">Yes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legend Controls -->
                    <div class="legend-textbox-controls">
                        <div class="legend-controls">
                            <div class="control-header">
                                <div class="form-title" style="font-size: 13px;">Legend Controls</div>
                                <div class="checkbox-group" style="margin-bottom: 0;">
                                    <input type="checkbox" id="showLegend" checked onchange="updatePlot()">
                                    <label for="showLegend">Show Legend</label>
                                </div>
                            </div>
                            
                            <div class="legend-preview" id="legendPreview">
                                <div class="draggable-indicator">Drag me!</div>
                                <div style="font-size: 11px; color: #666;">Legend Preview</div>
                            </div>
                            
                            <div class="input-group">
                                <label>Position:</label>
                                <div class="position-buttons">
                                    <button onclick="setLegendPosition('top left')">â†– Top Left</button>
                                    <button onclick="setLegendPosition('top center')">â†‘ Top Center</button>
                                    <button onclick="setLegendPosition('top right')">â†— Top Right</button>
                                    <button onclick="setLegendPosition('middle left')">â† Middle Left</button>
                                    <button onclick="setLegendPosition('middle center')">â—Ž Center</button>
                                    <button onclick="setLegendPosition('middle right')">â†’ Middle Right</button>
                                    <button onclick="setLegendPosition('bottom left')">â†™ Bottom Left</button>
                                    <button onclick="setLegendPosition('bottom center')">â†“ Bottom Center</button>
                                    <button onclick="setLegendPosition('bottom right')">â†˜ Bottom Right</button>
                                </div>
                            </div>
                            
                            <div class="move-controls">
                                <button onclick="moveLegend('left')">â† Left</button>
                                <button onclick="moveLegend('up')">â†‘ Up</button>
                                <button onclick="moveLegend('down')">â†“ Down</button>
                                <button onclick="moveLegend('right')">â†’ Right</button>
                            </div>
                            
                            <div class="input-group">
                                <label>Background Color:</label>
                                <div class="color-with-opacity">
                                    <input type="color" id="legendBgColor" value="#ffffff" onchange="updatePlot()">
                                    <div class="opacity-slider">
                                        <input type="range" id="legendBgOpacity" min="0" max="100" value="100" 
                                            oninput="document.getElementById('legendOpacityValue').textContent = this.value + '%'; updatePlot()">
                                        <span class="opacity-value" id="legendOpacityValue">100%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label>Border:</label>
                                <div style="display: grid; grid-template-columns: 1fr 80px 60px; gap: 8px;">
                                    <input type="color" id="legendBorderColor" value="#e0e0e0" onchange="updatePlot()">
                                    <input type="number" id="legendBorderWidth" value="1" min="0" max="5" onchange="updatePlot()">
                                    <select id="legendBorderStyle" onchange="updatePlot()">
                                        <option value="solid">Solid</option>
                                        <option value="dashed">Dashed</option>
                                        <option value="dotted">Dotted</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="font-controls-grid">
                                <div class="input-group">
                                    <label for="legendFont">Font:</label>
                                    <select id="legendFont" onchange="updatePlot()">
                                        <option value="Arial">Arial</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Helvetica">Helvetica</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Verdana">Verdana</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Palatino">Palatino</option>
                                        <option value="Garamond">Garamond</option>
                                        <option value="Tahoma">Tahoma</option>
                                        <option value="Calibri">Calibri</option>
                                    </select>
                                </div>
                                
                                <div class="input-group">
                                    <label for="legendFontSize">Font Size:</label>
                                    <input type="number" id="legendFontSize" value="12" min="8" max="24" onchange="updatePlot()">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Text Box Controls -->
                        <div class="textbox-controls">
                            <div class="control-header">
                                <div class="form-title" style="font-size: 13px;">Text Box Controls</div>
                                <button onclick="addTextBox()" class="success">+ Add Text Box</button>
                            </div>
                            
                            <div class="textbox-preview-box" id="textboxPreview">
                                <div class="draggable-indicator">Drag me!</div>
                                <div style="font-size: 12px;">Text Preview</div>
                            </div>
                            
                            <div class="input-group">
                                <label for="textboxContent">Text Content:</label>
                                <textarea id="textboxContent" rows="2" placeholder="Enter text here..."></textarea>
                            </div>
                            
                            <div class="move-controls">
                                <button onclick="moveSelectedTextBox('left')">â† Left</button>
                                <button onclick="moveSelectedTextBox('up')">â†‘ Up</button>
                                <button onclick="moveSelectedTextBox('down')">â†“ Down</button>
                                <button onclick="moveSelectedTextBox('right')">â†’ Right</button>
                            </div>
                            
                            <div class="font-controls-grid">
                                <div class="input-group">
                                    <label for="textboxFont">Font:</label>
                                    <select id="textboxFont" onchange="updateSelectedTextBox()">
                                        <option value="Arial">Arial</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Helvetica">Helvetica</option>
                                        <option value="Georgia">Georgia</option>
                                        <option value="Verdana">Verdana</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Palatino">Palatino</option>
                                        <option value="Garamond">Garamond</option>
                                        <option value="Tahoma">Tahoma</option>
                                        <option value="Calibri">Calibri</option>
                                    </select>
                                </div>
                                
                                <div class="input-group">
                                    <label for="textboxFontSize">Font Size:</label>
                                    <input type="number" id="textboxFontSize" value="14" min="8" max="36" onchange="updateSelectedTextBox()">
                                </div>
                                
                                <div class="input-group">
                                    <label for="textboxFontColor">Font Color:</label>
                                    <input type="color" id="textboxFontColor" value="#000000" onchange="updateSelectedTextBox()">
                                </div>
                                
                                <div class="input-group">
                                    <label for="textboxFontWeight">Font Weight:</label>
                                    <select id="textboxFontWeight" onchange="updateSelectedTextBox()">
                                        <option value="normal">Normal</option>
                                        <option value="bold">Bold</option>
                                    </select>
                                </div>
                                
                                <div class="input-group">
                                    <label for="textboxFontStyle">Font Style:</label>
                                    <select id="textboxFontStyle" onchange="updateSelectedTextBox()">
                                        <option value="normal">Normal</option>
                                        <option value="italic">Italic</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label>Background:</label>
                                <div class="color-with-opacity">
                                    <input type="color" id="textboxBgColor" value="#ffffff" onchange="updateSelectedTextBox()">
                                    <div class="opacity-slider">
                                        <input type="range" id="textboxBgOpacity" min="0" max="100" value="100"
                                            oninput="document.getElementById('textboxOpacityValue').textContent = this.value + '%'; updateSelectedTextBox()">
                                        <span class="opacity-value" id="textboxOpacityValue">100%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label>Border:</label>
                                <div style="display: grid; grid-template-columns: 1fr 80px 60px; gap: 8px;">
                                    <input type="color" id="textboxBorderColor" value="#e0e0e0" onchange="updateSelectedTextBox()">
                                    <input type="number" id="textboxBorderWidth" value="1" min="0" max="5" onchange="updateSelectedTextBox()">
                                    <select id="textboxBorderStyle" onchange="updateSelectedTextBox()">
                                        <option value="solid">Solid</option>
                                        <option value="dashed">Dashed</option>
                                        <option value="dotted">Dotted</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="textbox-list" id="textboxList">
                                <!-- Text boxes will be listed here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="showGrid" checked onchange="updatePlot()">
                        <label for="showGrid">Show Grid</label>
                    </div>
                    
                    <button onclick="downloadPlot()" class="full-width success">
                        ðŸ’¾ Download as PNG
                    </button>
                </div>
                <div id="plotDiv"></div>
            </div>
            
            <!-- Right Panel: Trace Manager -->
            <div class="panel right-panel" id="rightPanel">
                <div class="panel-header">
                    <div class="panel-title">ðŸŽ¨ Trace Manager</div>
                    <button class="collapse-btn" onclick="togglePanel('right')">â–¶</button>
                </div>
                
                <div class="add-trace-form">
                    <div class="form-title">Add New Trace</div>
                    
                    <div class="input-group">
                        <label for="traceXColumn">X Column:</label>
                        <select id="traceXColumn">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="traceYColumn">Y Column:</label>
                        <select id="traceYColumn">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="traceName">Trace Name:</label>
                        <input type="text" id="traceName" placeholder="My Trace">
                    </div>
                    
                    <div class="input-group">
                        <label>Plot Type:</label>
                        <div class="button-grid">
                            <button onclick="selectPlotType('scatter')" id="type-scatter">Scatter</button>
                            <button onclick="selectPlotType('line')" id="type-line" class="primary">Line</button>
                            <button onclick="selectPlotType('bar')" id="type-bar">Bar</button>
                            <button onclick="selectPlotType('area')" id="type-area">Area</button>
                            <button onclick="selectPlotType('scatterline')" id="type-scatterline">Scatter+Line</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="traceColor">Base Color:</label>
                        <input type="color" id="traceColor" value="#667eea">
                    </div>
                    
                    <div class="input-group">
                        <label for="traceWidth">Default Size:</label>
                        <input type="number" id="traceWidth" value="2" min="1" max="10">
                    </div>
                    
                    <button onclick="addTrace()" class="full-width success">
                        âž• Add Trace
                    </button>
                </div>
                
                <div>
                    <div style="font-weight: 600; margin-bottom: 12px; font-size: 13px; color: #333;">
                        Active Traces (<span id="traceCount">0</span>)
                    </div>
                    <div id="traceList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Panel Stack -->
    <div class="edit-panel-stack" id="editPanelStack"></div>
    
    <!-- Expand tabs (shown when panels are collapsed) -->
    <div class="expand-tab left" id="expandLeft" style="display: none;" onclick="togglePanel('left')">
        DATA INPUT
    </div>
    <div class="expand-tab right" id="expandRight" style="display: none;" onclick="togglePanel('right')">
        TRACE MANAGER
    </div>
    
    <script>
        let parsedData = null;
        let traces = [];
        let textBoxes = [];
        let currentPlotType = 'line';
        let traceIdCounter = 0;
        let textBoxIdCounter = 0;
        let collapsedPanels = { left: false, right: false };
        let openEditPanels = new Set();
        let stylePopupOpen = false;
        let selectedTextBoxId = null;
        let isDraggingLegend = false;
        let isDraggingTextBox = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let legendPosition = { x: 1, y: 1, xanchor: 'right', yanchor: 'top' };
        
        // Frame and border settings
        let plotDimensions = {
            width: null,
            height: null,
            widthUnit: 'px',
            heightUnit: 'px',
            autoWidth: true,
            autoHeight: true,
            lockAspectRatio: false,
            aspectRatio: 4/3
        };
        
        const colorPalette = [
            '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
            '#43e97b', '#38f9d7', '#fa709a', '#fee140', '#30cfd0',
            '#a8edea', '#fed6e3', '#ff6b6b', '#4ecdc4', '#45b7d1',
            '#f7b731', '#5f27cd', '#00d2d3', '#1dd1a1', '#feca57',
            '#ff9ff3', '#54a0ff', '#48dbfb', '#0abde3', '#ee5a6f'
        ];
        
        // Initialize controls
        document.getElementById('xScaleType').addEventListener('change', function() {
            document.getElementById('xCustomBase').style.display = this.value === 'log' ? 'block' : 'none';
            updatePlot();
        });
        
        document.getElementById('yScaleType').addEventListener('change', function() {
            document.getElementById('yCustomBase').style.display = this.value === 'log' ? 'block' : 'none';
            updatePlot();
        });
        
        // Initialize frame and border preview
        updateFramePreview();
        
        function parseDataInput() {
            const input = document.getElementById('dataInput').value.trim();
            if (!input) {
                alert('Please paste some data first!');
                return;
            }
            
            const lines = input.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('Need at least a header row and one data row!');
                return;
            }
            
            const delimiter = lines[0].includes('\t') ? '\t' : ',';
            const headers = lines[0].split(delimiter).map(h => h.trim());
            
            const data = {};
            headers.forEach(h => data[h] = []);
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter).map(v => v.trim());
                headers.forEach((h, idx) => {
                    const val = parseFloat(values[idx]);
                    data[h].push(isNaN(val) ? values[idx] : val);
                });
            }
            
            parsedData = { headers, data };
            updateColumnSelectors();
            
            document.getElementById('dataInfo').innerHTML = 
                `âœ“ Loaded ${headers.length} columns Ã— ${lines.length - 1} rows`;
        }
        
        function updateColumnSelectors() {
            if (!parsedData) return;
            
            const xSelect = document.getElementById('traceXColumn');
            const ySelect = document.getElementById('traceYColumn');
            
            xSelect.innerHTML = '<option value="">-- Select Column --</option>';
            ySelect.innerHTML = '<option value="">-- Select Column --</option>';
            
            parsedData.headers.forEach(h => {
                xSelect.innerHTML += `<option value="${h}">${h}</option>`;
                ySelect.innerHTML += `<option value="${h}">${h}</option>`;
            });
        }
        
        // Plot Frame and Border Functions
        function setDimensionUnit(dimension, unit) {
            const pxBtn = document.getElementById(`${dimension}Px`);
            const cmBtn = document.getElementById(`${dimension}Cm`);
            
            // Update button styles
            pxBtn.classList.toggle('primary', unit === 'px');
            cmBtn.classList.toggle('primary', unit === 'cm');
            
            // Update unit display
            document.getElementById(`${dimension}Unit`).value = unit;
            plotDimensions[`${dimension}Unit`] = unit;
            
            // Convert value if needed
            const input = document.getElementById(`plot${dimension.charAt(0).toUpperCase() + dimension.slice(1)}`);
            if (unit === 'cm' && plotDimensions[`${dimension}Unit`] === 'px') {
                // Convert px to cm (assuming 96px per inch, 2.54cm per inch)
                input.value = Math.round((parseFloat(input.value) / 96) * 2.54 * 10) / 10;
            } else if (unit === 'px' && plotDimensions[`${dimension}Unit`] === 'cm') {
                // Convert cm to px
                input.value = Math.round((parseFloat(input.value) / 2.54) * 96);
            }
            
            plotDimensions[`${dimension}Unit`] = unit;
            updatePlotDimensions();
        }
        
        function toggleAutoDimension(dimension) {
            const autoCheckbox = document.getElementById(`auto${dimension.charAt(0).toUpperCase() + dimension.slice(1)}`);
            const input = document.getElementById(`plot${dimension.charAt(0).toUpperCase() + dimension.slice(1)}`);
            const unitInput = document.getElementById(`${dimension}Unit`);
            
            plotDimensions[`auto${dimension.charAt(0).toUpperCase() + dimension.slice(1)}`] = autoCheckbox.checked;
            
            if (autoCheckbox.checked) {
                input.disabled = true;
                unitInput.disabled = true;
                plotDimensions[dimension] = null;
            } else {
                input.disabled = false;
                unitInput.disabled = false;
                plotDimensions[dimension] = parseFloat(input.value);
            }
            
            updatePlotDimensions();
        }
        
        function toggleAspectRatioLock() {
            plotDimensions.lockAspectRatio = document.getElementById('lockAspectRatio').checked;
            if (plotDimensions.lockAspectRatio) {
                // Calculate current aspect ratio
                const width = plotDimensions.width || parseFloat(document.getElementById('plotWidth').value);
                const height = plotDimensions.height || parseFloat(document.getElementById('plotHeight').value);
                plotDimensions.aspectRatio = width / height;
            }
            updatePlotDimensions();
        }
        
        function updatePlotDimensions() {
            if (plotDimensions.lockAspectRatio && !plotDimensions.autoWidth && !plotDimensions.autoHeight) {
                // If aspect ratio is locked and both dimensions are manual
                const widthInput = document.getElementById('plotWidth');
                const heightInput = document.getElementById('plotHeight');
                const width = parseFloat(widthInput.value);
                const height = parseFloat(heightInput.value);
                
                // Check which input was changed
                const activeElement = document.activeElement;
                if (activeElement === widthInput) {
                    // Width was changed, update height to maintain aspect ratio
                    const newHeight = width / plotDimensions.aspectRatio;
                    heightInput.value = Math.round(newHeight * 10) / 10;
                    plotDimensions.height = newHeight;
                } else if (activeElement === heightInput) {
                    // Height was changed, update width to maintain aspect ratio
                    const newWidth = height * plotDimensions.aspectRatio;
                    widthInput.value = Math.round(newWidth * 10) / 10;
                    plotDimensions.width = newWidth;
                }
            }
            
            // Update plot
            updatePlot();
            updateFramePreview();
        }
        
        function getPlotDimensions() {
            const dimensions = {};
            
            if (!plotDimensions.autoWidth && plotDimensions.width !== null) {
                dimensions.width = plotDimensions.widthUnit === 'cm' ? 
                    (plotDimensions.width / 2.54) * 96 : // Convert cm to px
                    plotDimensions.width;
            }
            
            if (!plotDimensions.autoHeight && plotDimensions.height !== null) {
                dimensions.height = plotDimensions.heightUnit === 'cm' ? 
                    (plotDimensions.height / 2.54) * 96 : // Convert cm to px
                    plotDimensions.height;
            }
            
            return dimensions;
        }
        
        function getFrameConfig() {
            return {
                showLeftAxis: document.getElementById('showLeftAxis').checked,
                showRightAxis: document.getElementById('showRightAxis').checked,
                showBottomAxis: document.getElementById('showBottomAxis').checked,
                showTopAxis: document.getElementById('showTopAxis').checked,
                leftAxisColor: document.getElementById('leftAxisColor').value,
                rightAxisColor: document.getElementById('rightAxisColor').value,
                bottomAxisColor: document.getElementById('bottomAxisColor').value,
                topAxisColor: document.getElementById('topAxisColor').value,
                leftAxisThickness: parseInt(document.getElementById('leftAxisThickness').value),
                rightAxisThickness: parseInt(document.getElementById('rightAxisThickness').value),
                bottomAxisThickness: parseInt(document.getElementById('bottomAxisThickness').value),
                topAxisThickness: parseInt(document.getElementById('topAxisThickness').value)
            };
        }
        
        function updateOuterBorder() {
            const plotDiv = document.getElementById('plotDiv');
            const borderColor = document.getElementById('outerBorderColor').value;
            const borderThickness = parseInt(document.getElementById('outerBorderThickness').value);
            const borderStyle = document.getElementById('outerBorderStyle').value;
            const borderRadius = parseInt(document.getElementById('outerBorderRadius').value);
            const showShadow = document.getElementById('showBorderShadow').checked;
            const showInnerGlow = document.getElementById('showInnerGlow').checked;
            
            let boxShadow = 'none';
            if (showShadow) {
                boxShadow = `0 4px 20px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1)`;
            }
            
            let innerGlow = 'none';
            if (showInnerGlow) {
                innerGlow = `inset 0 0 20px rgba(102, 126, 234, 0.1)`;
            }
            
            plotDiv.style.border = `${borderThickness}px ${borderStyle} ${borderColor}`;
            plotDiv.style.borderRadius = `${borderRadius}px`;
            plotDiv.style.boxShadow = `${boxShadow}, ${innerGlow}`.replace(', none', '').replace('none, ', '');
            
            updateFramePreview();
        }
        
        function updateFramePreview() {
            const preview = document.getElementById('borderPreview');
            const innerFrame = document.getElementById('innerFramePreview');
            const frameConfig = getFrameConfig();
            
            // Update outer border preview
            const borderColor = document.getElementById('outerBorderColor').value;
            const borderThickness = parseInt(document.getElementById('outerBorderThickness').value);
            const borderStyle = document.getElementById('outerBorderStyle').value;
            const borderRadius = parseInt(document.getElementById('outerBorderRadius').value);
            const showShadow = document.getElementById('showBorderShadow').checked;
            const showInnerGlow = document.getElementById('showInnerGlow').checked;
            
            let boxShadow = 'none';
            if (showShadow) {
                boxShadow = `0 4px 12px rgba(0, 0, 0, 0.1)`;
            }
            
            preview.style.border = `${borderThickness}px ${borderStyle} ${borderColor}`;
            preview.style.borderRadius = `${borderRadius}px`;
            preview.style.boxShadow = boxShadow;
            
            // Update inner frame preview
            let borderString = '';
            if (frameConfig.showLeftAxis) {
                borderString += `left: ${frameConfig.leftAxisThickness}px solid ${frameConfig.leftAxisColor}; `;
            }
            if (frameConfig.showRightAxis) {
                borderString += `right: ${frameConfig.rightAxisThickness}px solid ${frameConfig.rightAxisColor}; `;
            }
            if (frameConfig.showBottomAxis) {
                borderString += `bottom: ${frameConfig.bottomAxisThickness}px solid ${frameConfig.bottomAxisColor}; `;
            }
            if (frameConfig.showTopAxis) {
                borderString += `top: ${frameConfig.topAxisThickness}px solid ${frameConfig.topAxisColor}; `;
            }
            
            innerFrame.style = borderString;
            
            // Add inner glow if enabled
            if (showInnerGlow) {
                innerFrame.style.boxShadow = 'inset 0 0 15px rgba(102, 126, 234, 0.2)';
            }
        }
        
        function resetFrameBorders() {
            // Reset dimensions
            document.getElementById('autoWidth').checked = true;
            document.getElementById('autoHeight').checked = true;
            document.getElementById('lockAspectRatio').checked = false;
            
            plotDimensions.autoWidth = true;
            plotDimensions.autoHeight = true;
            plotDimensions.lockAspectRatio = false;
            
            document.getElementById('plotWidth').value = 800;
            document.getElementById('plotHeight').value = 600;
            document.getElementById('plotWidth').disabled = true;
            document.getElementById('plotHeight').disabled = true;
            
            // Reset frame sides
            document.getElementById('showLeftAxis').checked = true;
            document.getElementById('showRightAxis').checked = false;
            document.getElementById('showBottomAxis').checked = true;
            document.getElementById('showTopAxis').checked = false;
            
            document.getElementById('leftAxisColor').value = '#000000';
            document.getElementById('rightAxisColor').value = '#000000';
            document.getElementById('bottomAxisColor').value = '#000000';
            document.getElementById('topAxisColor').value = '#000000';
            
            document.getElementById('leftAxisThickness').value = 2;
            document.getElementById('rightAxisThickness').value = 2;
            document.getElementById('bottomAxisThickness').value = 2;
            document.getElementById('topAxisThickness').value = 2;
            
            document.getElementById('leftAxisThicknessValue').textContent = '2';
            document.getElementById('rightAxisThicknessValue').textContent = '2';
            document.getElementById('bottomAxisThicknessValue').textContent = '2';
            document.getElementById('topAxisThicknessValue').textContent = '2';
            
            // Reset outer border
            document.getElementById('outerBorderColor').value = '#000000';
            document.getElementById('outerBorderThickness').value = 2;
            document.getElementById('outerBorderThicknessValue').textContent = '2';
            document.getElementById('outerBorderStyle').value = 'solid';
            document.getElementById('outerBorderRadius').value = 8;
            document.getElementById('outerBorderRadiusValue').textContent = '8';
            document.getElementById('showBorderShadow').checked = false;
            document.getElementById('showInnerGlow').checked = false;
            
            // Update everything
            updatePlotDimensions();
            updateOuterBorder();
            updatePlot();
        }
        
        function selectPlotType(type) {
            currentPlotType = type;
            document.querySelectorAll('.button-grid button').forEach(btn => {
                btn.classList.remove('primary');
            });
            document.getElementById(`type-${type}`).classList.add('primary');
            
            // Open style popup for this type
            openStylePopup(type, 'add');
        }
        
        function openStylePopup(plotType, mode, traceId = null) {
            // Close any existing style popup
            const existingPopup = document.getElementById('style-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            stylePopupOpen = true;
            
            // Get current settings if editing existing trace
            let settings = {};
            if (mode === 'edit' && traceId !== null) {
                const trace = traces.find(t => t.id === traceId);
                if (trace && trace.styleSettings) {
                    settings = trace.styleSettings;
                }
            }
            
            // Default settings for each type
            const defaults = {
                scatter: {
                    symbol: settings.symbol || 'circle',
                    size: settings.size || 8,
                    fillColor: settings.fillColor || '#667eea',
                    strokeColor: settings.strokeColor || '#667eea',
                    strokeWidth: settings.strokeWidth || 1
                },
                line: {
                    pattern: settings.pattern || 'solid',
                    thickness: settings.thickness || 2
                },
                bar: {
                    pattern: settings.pattern || 'solid',
                    width: settings.width || 0.8,
                    base: settings.base || 0,
                    opacity: settings.opacity || 1
                },
                area: {
                    pattern: settings.pattern || 'solid',
                    thickness: settings.thickness || 2,
                    opacity: settings.opacity || 0.5
                },
                scatterline: {
                    symbol: settings.symbol || 'circle',
                    size: settings.size || 8,
                    fillColor: settings.fillColor || '#667eea',
                    strokeColor: settings.strokeColor || '#667eea',
                    strokeWidth: settings.strokeWidth || 1,
                    pattern: settings.pattern || 'solid',
                    thickness: settings.thickness || 2
                }
            };
            
            const currentSettings = defaults[plotType] || {};
            const baseColor = mode === 'edit' && traceId !== null ? 
                traces.find(t => t.id === traceId)?.color || '#667eea' : 
                document.getElementById('traceColor').value;
            
            const popup = document.createElement('div');
            popup.className = 'edit-panel-overlay active';
            popup.id = 'style-popup';
            popup.style.width = '380px';
            popup.style.right = '0';
            
            let contentHTML = '';
            let previewHTML = '';
            
            // Style Preview Box
            if (plotType === 'scatter' || plotType === 'scatterline') {
                previewHTML = `
                    <div class="style-preview">
                        <div class="preview-scatter">
                            <div style="width: ${currentSettings.size || 8}px; height: ${currentSettings.size || 8}px; 
                                 background: ${currentSettings.fillColor || baseColor}; 
                                 border: ${currentSettings.strokeWidth || 1}px solid ${currentSettings.strokeColor || baseColor};
                                 border-radius: ${currentSettings.symbol === 'circle' ? '50%' : '0'};
                                 transform: ${currentSettings.symbol === 'diamond' ? 'rotate(45deg)' : 
                                            currentSettings.symbol === 'triangle-up' ? 'rotate(0)' :
                                            currentSettings.symbol === 'triangle-down' ? 'rotate(180deg)' : 'none'};
                                 clip-path: ${currentSettings.symbol === 'triangle-up' ? 'polygon(50% 0%, 0% 100%, 100% 100%)' :
                                            currentSettings.symbol === 'triangle-down' ? 'polygon(50% 100%, 0% 0%, 100% 0%)' : 'none'}">
                            </div>
                        </div>
                    </div>
                `;
            } else if (plotType === 'line') {
                previewHTML = `
                    <div class="style-preview">
                        <div class="preview-line" 
                             style="border-bottom: ${currentSettings.thickness || 2}px ${currentSettings.pattern || 'solid'} ${baseColor}">
                        </div>
                    </div>
                `;
            } else if (plotType === 'bar') {
                previewHTML = `
                    <div class="style-preview">
                        <div class="preview-bar">
                            <div style="height: 60%; background: ${baseColor}; 
                                 width: ${(currentSettings.width || 0.8) * 20}px;
                                 opacity: ${currentSettings.opacity || 1};
                                 background-image: ${getPatternStyle(currentSettings.pattern || 'solid', baseColor)}">
                            </div>
                            <div style="height: 40%; background: ${baseColor}; 
                                 width: ${(currentSettings.width || 0.8) * 20}px;
                                 opacity: ${currentSettings.opacity || 1};
                                 background-image: ${getPatternStyle(currentSettings.pattern || 'solid', baseColor)}">
                            </div>
                        </div>
                    </div>
                `;
            } else if (plotType === 'area') {
                previewHTML = `
                    <div class="style-preview">
                        <div style="width: 80%; height: 60%; 
                             background: ${baseColor};
                             opacity: ${currentSettings.opacity || 0.5};
                             border-top: ${currentSettings.thickness || 2}px ${currentSettings.pattern || 'solid'} ${baseColor};
                             clip-path: polygon(0% 100%, 30% 40%, 70% 60%, 100% 100%)">
                        </div>
                    </div>
                `;
            }
            
            if (plotType === 'scatter' || plotType === 'scatterline') {
                contentHTML += `
                    <div class="form-title" style="margin-bottom: 16px; color: #333;">Scatter Settings</div>
                    ${previewHTML}
                    
                    <div class="input-group">
                        <label>Symbol Type:</label>
                        <select id="style-symbol" style="padding: 10px;" onchange="updateStylePreview('${plotType}')">
                            <option value="circle" ${currentSettings.symbol === 'circle' ? 'selected' : ''}>â— Circle</option>
                            <option value="square" ${currentSettings.symbol === 'square' ? 'selected' : ''}>â–  Square</option>
                            <option value="diamond" ${currentSettings.symbol === 'diamond' ? 'selected' : ''}>â—† Diamond</option>
                            <option value="cross" ${currentSettings.symbol === 'cross' ? 'selected' : ''}>âœ• Cross</option>
                            <option value="x" ${currentSettings.symbol === 'x' ? 'selected' : ''}>âœ— X</option>
                            <option value="triangle-up" ${currentSettings.symbol === 'triangle-up' ? 'selected' : ''}>â–² Triangle Up</option>
                            <option value="triangle-down" ${currentSettings.symbol === 'triangle-down' ? 'selected' : ''}>â–¼ Triangle Down</option>
                            <option value="star" ${currentSettings.symbol === 'star' ? 'selected' : ''}>â˜… Star</option>
                            <option value="pentagon" ${currentSettings.symbol === 'pentagon' ? 'selected' : ''}>â¬Ÿ Pentagon</option>
                            <option value="hexagon" ${currentSettings.symbol === 'hexagon' ? 'selected' : ''}>â¬¢ Hexagon</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Symbol Size: <span class="range-value" id="size-value">${currentSettings.size || 8}</span></label>
                        <input type="range" id="style-size" min="3" max="20" value="${currentSettings.size || 8}" 
                            oninput="document.getElementById('size-value').textContent = this.value; updateStylePreview('${plotType}')"
                            style="width: 100%; cursor: pointer;">
                    </div>
                    
                    <div class="input-group">
                        <label>Fill Color:</label>
                        <input type="color" id="style-fill-color" value="${currentSettings.fillColor || baseColor}" 
                            onchange="updateStylePreview('${plotType}')">
                    </div>
                    
                    <div class="input-group">
                        <label>Stroke Color:</label>
                        <input type="color" id="style-stroke-color" value="${currentSettings.strokeColor || baseColor}" 
                            onchange="updateStylePreview('${plotType}')">
                    </div>
                    
                    <div class="input-group">
                        <label>Stroke Width: <span class="range-value" id="stroke-width-value">${currentSettings.strokeWidth || 1}</span></label>
                        <input type="range" id="style-stroke-width" min="1" max="5" value="${currentSettings.strokeWidth || 1}"
                            oninput="document.getElementById('stroke-width-value').textContent = this.value; updateStylePreview('${plotType}')"
                            style="width: 100%; cursor: pointer;">
                    </div>
                `;
            }
            
            if (plotType === 'line' || plotType === 'scatterline' || plotType === 'area') {
                if (plotType === 'scatterline') {
                    contentHTML += `<div class="form-title" style="margin: 20px 0 16px; color: #333;">Line Settings</div>`;
                } else if (plotType === 'area') {
                    contentHTML += `<div class="form-title" style="margin: 20px 0 16px; color: #333;">Area Settings</div>`;
                    contentHTML += previewHTML;
                }
                
                contentHTML += `
                    <div class="input-group">
                        <label>Line Pattern:</label>
                        <select id="style-pattern" style="padding: 10px;" onchange="updateStylePreview('${plotType}')">
                            <option value="solid" ${currentSettings.pattern === 'solid' ? 'selected' : ''}>Solid â”€â”€â”€â”€</option>
                            <option value="dash" ${currentSettings.pattern === 'dash' ? 'selected' : ''}>Dashed â”€ â”€ â”€</option>
                            <option value="dot" ${currentSettings.pattern === 'dot' ? 'selected' : ''}>Dotted Â· Â· Â· Â·</option>
                            <option value="dashdot" ${currentSettings.pattern === 'dashdot' ? 'selected' : ''}>Dash-Dot â”€Â·â”€Â·</option>
                            <option value="longdash" ${currentSettings.pattern === 'longdash' ? 'selected' : ''}>Long Dash â”€â”€â”€â”€</option>
                            <option value="longdashdot" ${currentSettings.pattern === 'longdashdot' ? 'selected' : ''}>Long Dash-Dot â”€â”€â”€Â·</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Line Thickness: <span class="range-value" id="thickness-value">${currentSettings.thickness || 2}</span>px</label>
                        <input type="range" id="style-thickness" min="1" max="10" value="${currentSettings.thickness || 2}"
                            oninput="document.getElementById('thickness-value').textContent = this.value; updateStylePreview('${plotType}')"
                            style="width: 100%; cursor: pointer;">
                    </div>
                `;
                
                if (plotType === 'area') {
                    contentHTML += `
                        <div class="input-group">
                            <label>Area Opacity: <span class="range-value" id="opacity-value">${currentSettings.opacity || 0.5}</span></label>
                            <input type="range" id="style-opacity" min="0.1" max="1" step="0.1" value="${currentSettings.opacity || 0.5}"
                                oninput="document.getElementById('opacity-value').textContent = this.value; updateStylePreview('${plotType}')"
                                style="width: 100%; cursor: pointer;">
                        </div>
                    `;
                }
            }
            
            if (plotType === 'bar') {
                contentHTML += `
                    <div class="form-title" style="margin-bottom: 16px; color: #333;">Bar Settings</div>
                    ${previewHTML}
                    
                    <div class="input-group">
                        <label>Bar Pattern:</label>
                        <select id="style-pattern" style="padding: 10px;" onchange="updateStylePreview('${plotType}')">
                            <option value="solid" ${currentSettings.pattern === 'solid' ? 'selected' : ''}>Solid Fill</option>
                            <option value="/" ${currentSettings.pattern === '/' ? 'selected' : ''}>Diagonal /</option>
                            <option value="\\" ${currentSettings.pattern === '\\' ? 'selected' : ''}>Diagonal \\</option>
                            <option value="x" ${currentSettings.pattern === 'x' ? 'selected' : ''}>Crosshatch X</option>
                            <option value="-" ${currentSettings.pattern === '-' ? 'selected' : ''}>Horizontal Lines</option>
                            <option value="|" ${currentSettings.pattern === '|' ? 'selected' : ''}>Vertical Lines</option>
                            <option value="." ${currentSettings.pattern === '.' ? 'selected' : ''}>Dots</option>
                            <option value="+" ${currentSettings.pattern === '+' ? 'selected' : ''}>Plus Pattern</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Bar Width: <span class="range-value" id="width-value">${currentSettings.width || 0.8}</span></label>
                        <input type="range" id="style-width" min="0.1" max="2" step="0.1" value="${currentSettings.width || 0.8}"
                            oninput="document.getElementById('width-value').textContent = this.value; updateStylePreview('${plotType}')"
                            style="width: 100%; cursor: pointer;">
                    </div>
                    
                    <div class="input-group">
                        <label>Base (Y-axis start):</label>
                        <input type="number" id="style-base" value="${currentSettings.base || 0}" step="any"
                            style="padding: 10px;">
                    </div>
                    
                    <div class="input-group">
                        <label>Bar Opacity: <span class="range-value" id="opacity-value">${currentSettings.opacity || 1}</span></label>
                        <input type="range" id="style-opacity" min="0.1" max="1" step="0.1" value="${currentSettings.opacity || 1}"
                            oninput="document.getElementById('opacity-value').textContent = this.value; updateStylePreview('${plotType}')"
                            style="width: 100%; cursor: pointer;">
                    </div>
                `;
            }
            
            popup.innerHTML = `
                <div class="edit-panel-header">
                    <div class="edit-panel-title">ðŸŽ¨ ${plotType.charAt(0).toUpperCase() + plotType.slice(1)} Style Settings</div>
                    <button class="edit-panel-close" onclick="closeStylePopup()">âœ•</button>
                </div>
                <div class="edit-panel-content">
                    ${contentHTML}
                    
                    <button onclick="applyStyleSettings('${plotType}', '${mode}', ${traceId})" class="full-width success" style="margin-top: 20px;">
                        âœ“ Apply Settings
                    </button>
                    
                    <button onclick="closeStylePopup()" class="full-width" style="margin-top: 10px;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.getElementById('editPanelStack').appendChild(popup);
            
            // Trigger animation
            setTimeout(() => {
                popup.classList.add('active');
            }, 10);
        }
        
        function getPatternStyle(pattern, color) {
            const darkerColor = color.replace(')', ', 0.7)').replace('rgb', 'rgba');
            switch(pattern) {
                case '/': return `repeating-linear-gradient(45deg, transparent, transparent 5px, ${darkerColor} 5px, ${darkerColor} 10px)`;
                case '\\': return `repeating-linear-gradient(-45deg, transparent, transparent 5px, ${darkerColor} 5px, ${darkerColor} 10px)`;
                case 'x': return `repeating-linear-gradient(45deg, transparent, transparent 5px, ${darkerColor} 5px, ${darkerColor} 10px),
                                  repeating-linear-gradient(-45deg, transparent, transparent 5px, ${darkerColor} 5px, ${darkerColor} 10px)`;
                case '-': return `repeating-linear-gradient(0deg, transparent, transparent 5px, ${darkerColor} 5px, ${darkerColor} 10px)`;
                case '|': return `repeating-linear-gradient(90deg, transparent, transparent 5px, ${darkerColor} 5px, ${darkerColor} 10px)`;
                case '.': return `radial-gradient(${darkerColor} 2px, transparent 3px)`;
                case '+': return `repeating-linear-gradient(0deg, transparent, transparent 5px, ${darkerColor} 5px, ${darkerColor} 10px),
                                  repeating-linear-gradient(90deg, transparent, transparent 5px, ${darkerColor} 5px, ${darkerColor} 10px)`;
                default: return 'none';
            }
        }
        
        function updateStylePreview(plotType) {
            const preview = document.querySelector('.style-preview');
            if (!preview) return;
            
            if (plotType === 'scatter' || plotType === 'scatterline') {
                const symbol = document.getElementById('style-symbol')?.value || 'circle';
                const size = parseInt(document.getElementById('style-size')?.value || 8);
                const fillColor = document.getElementById('style-fill-color')?.value || '#667eea';
                const strokeColor = document.getElementById('style-stroke-color')?.value || '#667eea';
                const strokeWidth = parseInt(document.getElementById('style-stroke-width')?.value || 1);
                
                preview.innerHTML = `
                    <div class="preview-scatter">
                        <div style="width: ${size}px; height: ${size}px; 
                             background: ${fillColor}; 
                             border: ${strokeWidth}px solid ${strokeColor};
                             border-radius: ${symbol === 'circle' ? '50%' : '0'};
                             transform: ${symbol === 'diamond' ? 'rotate(45deg)' : 
                                        symbol === 'triangle-up' ? 'rotate(0)' :
                                        symbol === 'triangle-down' ? 'rotate(180deg)' : 'none'};
                             clip-path: ${symbol === 'triangle-up' ? 'polygon(50% 0%, 0% 100%, 100% 100%)' :
                                        symbol === 'triangle-down' ? 'polygon(50% 100%, 0% 0%, 100% 0%)' :
                                        symbol === 'star' ? 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)' : 'none'}">
                        </div>
                    </div>
                `;
            } else if (plotType === 'line') {
                const pattern = document.getElementById('style-pattern')?.value || 'solid';
                const thickness = parseInt(document.getElementById('style-thickness')?.value || 2);
                const baseColor = document.getElementById('traceColor').value;
                
                preview.innerHTML = `
                    <div class="preview-line" 
                         style="border-bottom: ${thickness}px ${pattern} ${baseColor}">
                    </div>
                `;
            } else if (plotType === 'bar') {
                const pattern = document.getElementById('style-pattern')?.value || 'solid';
                const width = parseFloat(document.getElementById('style-width')?.value || 0.8);
                const opacity = parseFloat(document.getElementById('style-opacity')?.value || 1);
                const baseColor = document.getElementById('traceColor').value;
                
                preview.innerHTML = `
                    <div class="preview-bar">
                        <div style="height: 60%; background: ${baseColor}; 
                             width: ${width * 20}px;
                             opacity: ${opacity};
                             background-image: ${getPatternStyle(pattern, baseColor)}">
                        </div>
                        <div style="height: 40%; background: ${baseColor}; 
                             width: ${width * 20}px;
                             opacity: ${opacity};
                             background-image: ${getPatternStyle(pattern, baseColor)}">
                        </div>
                    </div>
                `;
            } else if (plotType === 'area') {
                const pattern = document.getElementById('style-pattern')?.value || 'solid';
                const thickness = parseInt(document.getElementById('style-thickness')?.value || 2);
                const opacity = parseFloat(document.getElementById('style-opacity')?.value || 0.5);
                const baseColor = document.getElementById('traceColor').value;
                
                preview.innerHTML = `
                    <div style="width: 80%; height: 60%; 
                         background: ${baseColor};
                         opacity: ${opacity};
                         border-top: ${thickness}px ${pattern} ${baseColor};
                         clip-path: polygon(0% 100%, 30% 40%, 70% 60%, 100% 100%)">
                    </div>
                `;
            }
        }
        
        function closeStylePopup() {
            const popup = document.getElementById('style-popup');
            if (popup) {
                popup.classList.remove('active');
                setTimeout(() => {
                    popup.remove();
                    stylePopupOpen = false;
                }, 300);
            }
        }
        
        function applyStyleSettings(plotType, mode, traceId) {
            const settings = {};
            
            if (plotType === 'scatter' || plotType === 'scatterline') {
                settings.symbol = document.getElementById('style-symbol').value;
                settings.size = parseInt(document.getElementById('style-size').value);
                settings.fillColor = document.getElementById('style-fill-color').value;
                settings.strokeColor = document.getElementById('style-stroke-color').value;
                settings.strokeWidth = parseInt(document.getElementById('style-stroke-width').value);
            }
            
            if (plotType === 'line' || plotType === 'scatterline' || plotType === 'area') {
                settings.pattern = document.getElementById('style-pattern').value;
                settings.thickness = parseInt(document.getElementById('style-thickness').value);
            }
            
            if (plotType === 'bar') {
                settings.pattern = document.getElementById('style-pattern').value;
                settings.width = parseFloat(document.getElementById('style-width').value);
                settings.base = parseFloat(document.getElementById('style-base').value);
                settings.opacity = parseFloat(document.getElementById('style-opacity').value);
            }
            
            if (plotType === 'area') {
                settings.opacity = parseFloat(document.getElementById('style-opacity').value);
            }
            
            if (mode === 'add') {
                // Store settings temporarily (will be applied when trace is created)
                window.tempStyleSettings = settings;
            } else if (mode === 'edit' && traceId !== null) {
                const trace = traces.find(t => t.id === traceId);
                if (trace) {
                    trace.styleSettings = settings;
                    updateTraceList();
                    updatePlot();
                }
            }
            
            closeStylePopup();
        }
        
        function addTrace() {
            if (!parsedData) {
                alert('Please load data first!');
                return;
            }
            
            const xCol = document.getElementById('traceXColumn').value;
            const yCol = document.getElementById('traceYColumn').value;
            
            if (!xCol || !yCol) {
                alert('Please select both X and Y columns!');
                return;
            }
            
            const traceName = document.getElementById('traceName').value || 
                             `${yCol} vs ${xCol}`;
            const color = document.getElementById('traceColor').value;
            const width = parseInt(document.getElementById('traceWidth').value);
            
            const trace = {
                id: traceIdCounter++,
                name: traceName,
                xColumn: xCol,
                yColumn: yCol,
                type: currentPlotType,
                color: color,
                width: width,
                visible: true,
                styleSettings: window.tempStyleSettings || {}
            };
            
            // Clear temp settings
            window.tempStyleSettings = null;
            
            traces.push(trace);
            updateTraceList();
            updatePlot();
            
            // Auto-assign next color
            document.getElementById('traceColor').value = 
                colorPalette[traces.length % colorPalette.length];
        }
        
        function deleteTrace(id) {
            traces = traces.filter(t => t.id !== id);
            updateTraceList();
            updatePlot();
        }
        
        function toggleTraceVisibility(id) {
            const trace = traces.find(t => t.id === id);
            if (trace) {
                trace.visible = !trace.visible;
                updateTraceList();
                updatePlot();
            }
        }
        
        // Legend Functions
        function setLegendPosition(position) {
            const positions = {
                'top left': { x: 0, y: 1, xanchor: 'left', yanchor: 'top' },
                'top center': { x: 0.5, y: 1, xanchor: 'center', yanchor: 'top' },
                'top right': { x: 1, y: 1, xanchor: 'right', yanchor: 'top' },
                'middle left': { x: 0, y: 0.5, xanchor: 'left', yanchor: 'middle' },
                'middle center': { x: 0.5, y: 0.5, xanchor: 'center', yanchor: 'middle' },
                'middle right': { x: 1, y: 0.5, xanchor: 'right', yanchor: 'middle' },
                'bottom left': { x: 0, y: 0, xanchor: 'left', yanchor: 'bottom' },
                'bottom center': { x: 0.5, y: 0, xanchor: 'center', yanchor: 'bottom' },
                'bottom right': { x: 1, y: 0, xanchor: 'right', yanchor: 'bottom' }
            };
            
            legendPosition = positions[position] || positions['top right'];
            updatePlot();
            updateLegendPreview();
        }
        
        function moveLegend(direction) {
            const step = 0.02;
            switch(direction) {
                case 'left': legendPosition.x -= step; break;
                case 'right': legendPosition.x += step; break;
                case 'up': legendPosition.y += step; break;
                case 'down': legendPosition.y -= step; break;
            }
            
            // Clamp values
            legendPosition.x = Math.max(0, Math.min(1, legendPosition.x));
            legendPosition.y = Math.max(0, Math.min(1, legendPosition.y));
            
            updatePlot();
            updateLegendPreview();
        }
        
        function updateLegendPreview() {
            const preview = document.getElementById('legendPreview');
            if (!preview) return;
            
            const bgColor = document.getElementById('legendBgColor').value;
            const opacity = parseInt(document.getElementById('legendBgOpacity').value) / 100;
            const borderColor = document.getElementById('legendBorderColor').value;
            const borderWidth = parseInt(document.getElementById('legendBorderWidth').value);
            const borderStyle = document.getElementById('legendBorderStyle').value;
            const font = document.getElementById('legendFont').value;
            const fontSize = parseInt(document.getElementById('legendFontSize').value);
            
            const rgbaColor = hexToRgba(bgColor, opacity);
            
            preview.style.background = rgbaColor;
            preview.style.border = `${borderWidth}px ${borderStyle} ${borderColor}`;
            preview.style.fontFamily = font;
            preview.style.fontSize = `${fontSize}px`;
            
            // Show position indicator
            const posX = Math.round(legendPosition.x * 100);
            const posY = Math.round(legendPosition.y * 100);
            preview.querySelector('.draggable-indicator').textContent = `Position: ${posX}%, ${posY}%`;
        }
        
        // Text Box Functions
        function addTextBox() {
            const content = document.getElementById('textboxContent').value.trim() || 'New Text Box';
            const font = document.getElementById('textboxFont').value;
            const fontSize = parseInt(document.getElementById('textboxFontSize').value);
            const fontColor = document.getElementById('textboxFontColor').value;
            const fontWeight = document.getElementById('textboxFontWeight').value;
            const fontStyle = document.getElementById('textboxFontStyle').value;
            const bgColor = document.getElementById('textboxBgColor').value;
            const bgOpacity = parseInt(document.getElementById('textboxBgOpacity').value) / 100;
            const borderColor = document.getElementById('textboxBorderColor').value;
            const borderWidth = parseInt(document.getElementById('textboxBorderWidth').value);
            const borderStyle = document.getElementById('textboxBorderStyle').value;
            
            const textBox = {
                id: textBoxIdCounter++,
                content: content,
                x: 0.5,
                y: 0.5,
                xref: 'paper',
                yref: 'paper',
                xanchor: 'center',
                yanchor: 'middle',
                showarrow: false,
                font: {
                    family: font,
                    size: fontSize,
                    color: fontColor,
                    weight: fontWeight,
                    style: fontStyle
                },
                bgcolor: hexToRgba(bgColor, bgOpacity),
                bordercolor: borderColor,
                borderwidth: borderWidth,
                borderpad: 4,
                borderstyle: borderStyle,
                visible: true
            };
            
            textBoxes.push(textBox);
            selectedTextBoxId = textBox.id;
            updateTextBoxList();
            updatePlot();
            updateTextBoxPreview();
        }
        
        function selectTextBox(id) {
            selectedTextBoxId = id;
            updateTextBoxList();
            loadTextBoxSettings(id);
        }
        
        function loadTextBoxSettings(id) {
            const textBox = textBoxes.find(t => t.id === id);
            if (!textBox) return;
            
            document.getElementById('textboxContent').value = textBox.content;
            document.getElementById('textboxFont').value = textBox.font.family;
            document.getElementById('textboxFontSize').value = textBox.font.size;
            document.getElementById('textboxFontColor').value = textBox.font.color;
            document.getElementById('textboxFontWeight').value = textBox.font.weight;
            document.getElementById('textboxFontStyle').value = textBox.font.style;
            
            // Extract background color and opacity
            const bgMatch = textBox.bgcolor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
            if (bgMatch) {
                const [r, g, b, a = 1] = bgMatch.slice(1).map(Number);
                document.getElementById('textboxBgColor').value = rgbToHex(r, g, b);
                document.getElementById('textboxBgOpacity').value = Math.round(a * 100);
                document.getElementById('textboxOpacityValue').textContent = Math.round(a * 100) + '%';
            }
            
            document.getElementById('textboxBorderColor').value = textBox.bordercolor;
            document.getElementById('textboxBorderWidth').value = textBox.borderwidth;
            document.getElementById('textboxBorderStyle').value = textBox.borderstyle;
            
            updateTextBoxPreview();
        }
        
        function updateSelectedTextBox() {
            if (selectedTextBoxId === null) return;
            
            const textBox = textBoxes.find(t => t.id === selectedTextBoxId);
            if (!textBox) return;
            
            textBox.content = document.getElementById('textboxContent').value;
            textBox.font.family = document.getElementById('textboxFont').value;
            textBox.font.size = parseInt(document.getElementById('textboxFontSize').value);
            textBox.font.color = document.getElementById('textboxFontColor').value;
            textBox.font.weight = document.getElementById('textboxFontWeight').value;
            textBox.font.style = document.getElementById('textboxFontStyle').value;
            
            const bgColor = document.getElementById('textboxBgColor').value;
            const bgOpacity = parseInt(document.getElementById('textboxBgOpacity').value) / 100;
            textBox.bgcolor = hexToRgba(bgColor, bgOpacity);
            
            textBox.bordercolor = document.getElementById('textboxBorderColor').value;
            textBox.borderwidth = parseInt(document.getElementById('textboxBorderWidth').value);
            textBox.borderstyle = document.getElementById('textboxBorderStyle').value;
            
            updateTextBoxList();
            updatePlot();
            updateTextBoxPreview();
        }
        
        function moveSelectedTextBox(direction) {
            if (selectedTextBoxId === null) return;
            
            const textBox = textBoxes.find(t => t.id === selectedTextBoxId);
            if (!textBox) return;
            
            const step = 0.02;
            switch(direction) {
                case 'left': textBox.x -= step; break;
                case 'right': textBox.x += step; break;
                case 'up': textBox.y += step; break;
                case 'down': textBox.y -= step; break;
            }
            
            // Clamp values
            textBox.x = Math.max(0, Math.min(1, textBox.x));
            textBox.y = Math.max(0, Math.min(1, textBox.y));
            
            updateTextBoxList();
            updatePlot();
            updateTextBoxPreview();
        }
        
        function deleteTextBox(id) {
            textBoxes = textBoxes.filter(t => t.id !== id);
            if (selectedTextBoxId === id) {
                selectedTextBoxId = textBoxes.length > 0 ? textBoxes[0].id : null;
            }
            updateTextBoxList();
            updatePlot();
            updateTextBoxPreview();
        }
        
        function updateTextBoxList() {
            const list = document.getElementById('textboxList');
            list.innerHTML = '';
            
            textBoxes.forEach(textBox => {
                const isSelected = textBox.id === selectedTextBoxId;
                const item = document.createElement('div');
                item.className = `textbox-item ${isSelected ? 'selected' : ''}`;
                item.onclick = () => selectTextBox(textBox.id);
                
                const posX = Math.round(textBox.x * 100);
                const posY = Math.round(textBox.y * 100);
                
                item.innerHTML = `
                    <div class="textbox-item-header">
                        <div class="textbox-name">Text Box ${textBox.id + 1}</div>
                        <div style="font-size: 10px; color: #999;">${posX}%, ${posY}%</div>
                    </div>
                    <div class="textbox-preview">${textBox.content.substring(0, 30)}${textBox.content.length > 30 ? '...' : ''}</div>
                    <div class="textbox-actions">
                        <button onclick="event.stopPropagation(); selectTextBox(${textBox.id})">Edit</button>
                        <button class="danger" onclick="event.stopPropagation(); deleteTextBox(${textBox.id})">Delete</button>
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            if (textBoxes.length === 0) {
                list.innerHTML = '<p style="color: #999; font-size: 11px; text-align: center; padding: 10px;">No text boxes yet</p>';
            }
        }
        
        function updateTextBoxPreview() {
            const preview = document.getElementById('textboxPreview');
            if (!preview) return;
            
            const content = document.getElementById('textboxContent').value || 'Text Preview';
            const font = document.getElementById('textboxFont').value;
            const fontSize = parseInt(document.getElementById('textboxFontSize').value);
            const fontColor = document.getElementById('textboxFontColor').value;
            const fontWeight = document.getElementById('textboxFontWeight').value;
            const fontStyle = document.getElementById('textboxFontStyle').value;
            const bgColor = document.getElementById('textboxBgColor').value;
            const bgOpacity = parseInt(document.getElementById('textboxBgOpacity').value) / 100;
            const borderColor = document.getElementById('textboxBorderColor').value;
            const borderWidth = parseInt(document.getElementById('textboxBorderWidth').value);
            const borderStyle = document.getElementById('textboxBorderStyle').value;
            
            const rgbaColor = hexToRgba(bgColor, bgOpacity);
            
            preview.style.background = rgbaColor;
            preview.style.border = `${borderWidth}px ${borderStyle} ${borderColor}`;
            preview.style.fontFamily = font;
            preview.style.fontSize = `${fontSize}px`;
            preview.style.color = fontColor;
            preview.style.fontWeight = fontWeight;
            preview.style.fontStyle = fontStyle;
            preview.innerHTML = `
                <div class="draggable-indicator">Drag me!</div>
                <div>${content.substring(0, 20)}${content.length > 20 ? '...' : ''}</div>
            `;
        }
        
        // Helper functions
        function hexToRgba(hex, opacity = 1) {
            hex = hex.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        function toggleEditTrace(id) {
            const trace = traces.find(t => t.id === id);
            if (!trace || !parsedData) return;
            
            // Check if this panel is already open
            if (openEditPanels.has(id)) {
                closeEditPanel(id);
                return;
            }
            
            // Add to open panels
            openEditPanels.add(id);
            
            // Calculate offset based on number of open panels
            const panelIndex = Array.from(openEditPanels).indexOf(id);
            const offset = panelIndex * 30; // Stack with 30px offset
            
            // Create edit panel
            const panel = document.createElement('div');
            panel.className = 'edit-panel-overlay';
            panel.id = `edit-panel-${id}`;
            panel.style.right = `${offset}px`;
            
            panel.innerHTML = `
                <div class="edit-panel-header">
                    <div class="edit-panel-title">âœï¸ Edit: ${trace.name}</div>
                    <button class="edit-panel-close" onclick="closeEditPanel(${id})">âœ•</button>
                </div>
                <div class="edit-panel-content">
                    <div class="input-group">
                        <label>X Column:</label>
                        <select id="edit-x-${id}">
                            ${parsedData.headers.map(h => 
                                `<option value="${h}" ${h === trace.xColumn ? 'selected' : ''}>${h}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Y Column:</label>
                        <select id="edit-y-${id}">
                            ${parsedData.headers.map(h => 
                                `<option value="${h}" ${h === trace.yColumn ? 'selected' : ''}>${h}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Trace Name:</label>
                        <input type="text" id="edit-name-${id}" value="${trace.name}">
                    </div>
                    
                    <div class="input-group">
                        <label>Plot Type:</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; padding: 8px; border: 2px solid ${trace.type === 'scatter' ? '#667eea' : '#e0e0e0'}; border-radius: 6px; cursor: pointer; font-size: 12px; background: ${trace.type === 'scatter' ? '#f0f4ff' : 'white'};">
                                <input type="radio" name="edit-type-${id}" value="scatter" ${trace.type === 'scatter' ? 'checked' : ''} style="margin-right: 6px;">
                                Scatter
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px; border: 2px solid ${trace.type === 'line' ? '#667eea' : '#e0e0e0'}; border-radius: 6px; cursor: pointer; font-size: 12px; background: ${trace.type === 'line' ? '#f0f4ff' : 'white'};">
                                <input type="radio" name="edit-type-${id}" value="line" ${trace.type === 'line' ? 'checked' : ''} style="margin-right: 6px;">
                                Line
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px; border: 2px solid ${trace.type === 'bar' ? '#667eea' : '#e0e0e0'}; border-radius: 6px; cursor: pointer; font-size: 12px; background: ${trace.type === 'bar' ? '#f0f4ff' : 'white'};">
                                <input type="radio" name="edit-type-${id}" value="bar" ${trace.type === 'bar' ? 'checked' : ''} style="margin-right: 6px;">
                                Bar
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px; border: 2px solid ${trace.type === 'area' ? '#667eea' : '#e0e0e0'}; border-radius: 6px; cursor: pointer; font-size: 12px; background: ${trace.type === 'area' ? '#f0f4ff' : 'white'};">
                                <input type="radio" name="edit-type-${id}" value="area" ${trace.type === 'area' ? 'checked' : ''} style="margin-right: 6px;">
                                Area
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px; border: 2px solid ${trace.type === 'scatterline' ? '#667eea' : '#e0e0e0'}; border-radius: 6px; cursor: pointer; font-size: 12px; background: ${trace.type === 'scatterline' ? '#f0f4ff' : 'white'};">
                                <input type="radio" name="edit-type-${id}" value="scatterline" ${trace.type === 'scatterline' ? 'checked' : ''} style="margin-right: 6px;">
                                Scatter+Line
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Base Color:</label>
                        <input type="color" id="edit-color-${id}" value="${trace.color}">
                    </div>
                    
                    <div class="input-group">
                        <label>Default Size:</label>
                        <input type="number" id="edit-width-${id}" value="${trace.width}" min="1" max="10">
                    </div>
                    
                    <button onclick="openStylePopupForEdit(${id})" class="full-width" style="margin-top: 10px;">
                        ðŸŽ¨ Edit Style Settings
                    </button>
                    
                    <button onclick="updateTrace(${id})" class="full-width success" style="margin-top: 10px;">
                        âœ“ Update Trace
                    </button>
                    
                    <button onclick="closeEditPanel(${id})" class="full-width" style="margin-top: 10px;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.getElementById('editPanelStack').appendChild(panel);
            
            // Trigger animation
            setTimeout(() => {
                panel.classList.add('active');
            }, 10);
        }
        
        function openStylePopupForEdit(traceId) {
            const trace = traces.find(t => t.id === traceId);
            if (trace) {
                openStylePopup(trace.type, 'edit', traceId);
            }
        }
        
        function closeEditPanel(id) {
            const panel = document.getElementById(`edit-panel-${id}`);
            if (panel) {
                panel.classList.remove('active');
                setTimeout(() => {
                    panel.remove();
                    openEditPanels.delete(id);
                    repositionEditPanels();
                }, 300);
            }
        }
        
        function repositionEditPanels() {
            const openIds = Array.from(openEditPanels);
            openIds.forEach((id, index) => {
                const panel = document.getElementById(`edit-panel-${id}`);
                if (panel) {
                    panel.style.right = `${index * 30}px`;
                }
            });
        }
        
        function updateTrace(id) {
            const trace = traces.find(t => t.id === id);
            if (!trace) return;
            
            const newType = document.querySelector(`input[name="edit-type-${id}"]:checked`)?.value;
            if (newType && newType !== trace.type) {
                trace.type = newType;
                // Keep existing style settings when changing type
                if (!trace.styleSettings) trace.styleSettings = {};
            }
            
            trace.xColumn = document.getElementById(`edit-x-${id}`).value;
            trace.yColumn = document.getElementById(`edit-y-${id}`).value;
            trace.name = document.getElementById(`edit-name-${id}`).value;
            trace.color = document.getElementById(`edit-color-${id}`).value;
            trace.width = parseInt(document.getElementById(`edit-width-${id}`).value);
            
            updateTraceList();
            updatePlot();
            closeEditPanel(id);
        }
        
        function updateTraceList() {
            const list = document.getElementById('traceList');
            const count = document.getElementById('traceCount');
            
            count.textContent = traces.length;
            
            if (traces.length === 0) {
                list.innerHTML = '<p style="color: #999; font-size: 12px;">No traces yet. Add one above!</p>';
                return;
            }
            
            if (!parsedData) return;
            
            list.innerHTML = traces.map(trace => `
                <div class="trace-item" style="opacity: ${trace.visible ? 1 : 0.5}">
                    <div class="trace-header">
                        <div class="trace-name">${trace.name}</div>
                        <div class="trace-color" style="background: ${trace.color}"></div>
                    </div>
                    <div class="trace-info">
                        ${trace.type} | X: ${trace.xColumn} | Y: ${trace.yColumn}
                    </div>
                    <div class="trace-actions">
                        <button onclick="toggleTraceVisibility(${trace.id})" title="Toggle visibility">
                            ${trace.visible ? 'ðŸ‘ï¸' : 'ðŸ‘ï¸â€ðŸ—¨ï¸'}
                        </button>
                        <button onclick="toggleEditTrace(${trace.id})" title="Edit trace">
                            âœï¸
                        </button>
                        <button onclick="openStylePopupForEdit(${trace.id})" title="Style settings">
                            ðŸŽ¨
                        </button>
                        <button class="danger" onclick="deleteTrace(${trace.id})" title="Delete trace">
                            ðŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function toggleManualRange(axis) {
            const manualCheckbox = document.getElementById(`${axis}ManualRange`);
            const rangeControls = document.getElementById(`${axis}RangeControls`);
            
            if (manualCheckbox.checked) {
                rangeControls.style.display = 'block';
                // Try to auto-populate min/max based on current data
                if (parsedData && traces.length > 0) {
                    setTimeout(() => autoPopulateRange(axis), 100);
                }
            } else {
                rangeControls.style.display = 'none';
            }
            updatePlot();
        }
        
        function autoPopulateRange(axis) {
            const allValues = [];
            traces.forEach(trace => {
                if (trace.visible) {
                    const column = axis === 'x' ? trace.xColumn : trace.yColumn;
                    if (parsedData.data[column]) {
                        allValues.push(...parsedData.data[column]);
                    }
                }
            });
            
            if (allValues.length > 0) {
                const minVal = Math.min(...allValues);
                const maxVal = Math.max(...allValues);
                const range = maxVal - minVal;
                
                document.getElementById(`${axis}Min`).value = (minVal - range * 0.1).toFixed(2);
                document.getElementById(`${axis}Max`).value = (maxVal + range * 0.1).toFixed(2);
            }
        }
        
        function getScaleType(axis) {
            const scaleType = document.getElementById(`${axis}ScaleType`).value;
            if (scaleType === 'log') {
                const base = parseFloat(document.getElementById(`${axis}LogBase`).value);
                return { type: 'log', base: base };
            } else if (scaleType === 'loge') {
                return { type: 'log', base: Math.E };
            } else if (scaleType === 'log2') {
                return { type: 'log', base: 2 };
            } else if (scaleType === 'log10') {
                return { type: 'log', base: 10 };
            } else {
                return { type: 'linear' };
            }
        }
        
        function getAxisConfig(axis) {
            const scaleType = getScaleType(axis);
            const showMajorTicks = document.getElementById(`${axis}ShowMajorTicks`).checked;
            const showMinorTicks = document.getElementById(`${axis}ShowMinorTicks`).checked;
            const majorInterval = parseFloat(document.getElementById(`${axis}MajorInterval`).value);
            const minorTicks = parseInt(document.getElementById(`${axis}MinorTicks`).value);
            
            let tickvals, ticktext;
            if (showMajorTicks && majorInterval > 0) {
                // Calculate major tick positions
                const manualRange = document.getElementById(`${axis}ManualRange`).checked;
                if (manualRange) {
                    const min = parseFloat(document.getElementById(`${axis}Min`).value);
                    const max = parseFloat(document.getElementById(`${axis}Max`).value);
                    tickvals = [];
                    ticktext = [];
                    for (let val = min; val <= max; val += majorInterval) {
                        tickvals.push(val);
                        ticktext.push(val.toFixed(2));
                    }
                }
            }
            
            const config = {
                title: document.getElementById(`${axis}AxisLabel`).value,
                showgrid: document.getElementById('showGrid').checked,
                type: scaleType.type,
                ...scaleType
            };
            
            // Apply manual range if enabled
            if (document.getElementById(`${axis}ManualRange`).checked) {
                config.range = [
                    parseFloat(document.getElementById(`${axis}Min`).value),
                    parseFloat(document.getElementById(`${axis}Max`).value)
                ];
            }
            
            // Apply font settings
            config.titlefont = {
                family: document.getElementById(`${axis}LabelFont`).value,
                size: parseInt(document.getElementById(`${axis}LabelSize`).value),
                weight: document.getElementById(`${axis}LabelWeight`).value,
                style: document.getElementById(`${axis}LabelItalic`).value
            };
            
            config.tickfont = {
                family: document.getElementById(`${axis}TickFont`).value,
                size: parseInt(document.getElementById(`${axis}TickSize`).value)
            };
            
            // Apply tick settings
            if (!showMajorTicks) {
                config.showticklabels = false;
            } else {
                config.tickmode = 'auto';
                if (tickvals) {
                    config.tickvals = tickvals;
                    config.ticktext = ticktext;
                }
            }
            
            // Apply minor ticks (Plotly doesn't directly support minor ticks, but we can use gridlines)
            if (!showMinorTicks) {
                config.minor = {
                    ticklen: 0,
                    tickcolor: 'transparent',
                    showgrid: false
                };
            } else {
                config.minor = {
                    ticklen: 4,
                    tickcolor: '#ccc',
                    ticks: 'inside',
                    nticks: minorTicks
                };
            }
            
            // Apply frame settings
            const frameConfig = getFrameConfig();
            if (axis === 'x') {
                config.showline = frameConfig.showBottomAxis;
                config.linecolor = frameConfig.bottomAxisColor;
                config.linewidth = frameConfig.bottomAxisThickness;
                config.mirror = frameConfig.showTopAxis ? true : false;
            } else if (axis === 'y') {
                config.showline = frameConfig.showLeftAxis;
                config.linecolor = frameConfig.leftAxisColor;
                config.linewidth = frameConfig.leftAxisThickness;
                config.mirror = frameConfig.showRightAxis ? true : false;
            }
            
            // For logarithmic scales, adjust tick settings
            if (scaleType.type === 'log') {
                config.tickmode = 'auto';
                config.minorticklen = showMinorTicks ? 4 : 0;
            }
            
            return config;
        }
        
        function getLegendConfig() {
            const showLegend = document.getElementById('showLegend').checked;
            if (!showLegend) return { showlegend: false };
            
            const bgColor = document.getElementById('legendBgColor').value;
            const opacity = parseInt(document.getElementById('legendBgOpacity').value) / 100;
            const borderColor = document.getElementById('legendBorderColor').value;
            const borderWidth = parseInt(document.getElementById('legendBorderWidth').value);
            const borderStyle = document.getElementById('legendBorderStyle').value;
            const font = document.getElementById('legendFont').value;
            const fontSize = parseInt(document.getElementById('legendFontSize').value);
            
            return {
                showlegend: true,
                legend: {
                    x: legendPosition.x,
                    y: legendPosition.y,
                    xanchor: legendPosition.xanchor,
                    yanchor: legendPosition.yanchor,
                    bgcolor: hexToRgba(bgColor, opacity),
                    bordercolor: borderColor,
                    borderwidth: borderWidth,
                    font: {
                        family: font,
                        size: fontSize
                    }
                }
            };
        }
        
        function updatePlot() {
            if (!parsedData || traces.length === 0) {
                Plotly.newPlot('plotDiv', [], {
                    title: 'Add traces to see your plot',
                    annotations: [{
                        text: 'ðŸ‘ˆ Add data and traces to get started',
                        xref: 'paper',
                        yref: 'paper',
                        x: 0.5,
                        y: 0.5,
                        showarrow: false,
                        font: { size: 16, color: '#999' }
                    }]
                });
                return;
            }
            
            const plotlyTraces = traces.filter(t => t.visible).map(trace => {
                const xData = parsedData.data[trace.xColumn];
                const yData = parsedData.data[trace.yColumn];
                const style = trace.styleSettings || {};
                
                let plotTrace = {
                    x: xData,
                    y: yData,
                    name: trace.name
                };
                
                // Apply styling based on plot type
                switch(trace.type) {
                    case 'scatter':
                        plotTrace.mode = 'markers';
                        plotTrace.type = 'scatter';
                        plotTrace.marker = {
                            symbol: style.symbol || 'circle',
                            size: style.size || 8,
                            color: style.fillColor || trace.color,
                            line: {
                                color: style.strokeColor || trace.color,
                                width: style.strokeWidth || 1
                            }
                        };
                        break;
                        
                    case 'line':
                        plotTrace.mode = 'lines';
                        plotTrace.type = 'scatter';
                        plotTrace.line = {
                            color: trace.color,
                            width: style.thickness || trace.width,
                            dash: style.pattern || 'solid'
                        };
                        break;
                        
                    case 'scatterline':
                        plotTrace.mode = 'lines+markers';
                        plotTrace.type = 'scatter';
                        plotTrace.marker = {
                            symbol: style.symbol || 'circle',
                            size: style.size || 8,
                            color: style.fillColor || trace.color,
                            line: {
                                color: style.strokeColor || trace.color,
                                width: style.strokeWidth || 1
                            }
                        };
                        plotTrace.line = {
                            color: trace.color,
                            width: style.thickness || trace.width,
                            dash: style.pattern || 'solid'
                        };
                        break;
                        
                    case 'bar':
                        plotTrace.type = 'bar';
                        plotTrace.marker = {
                            color: trace.color,
                            opacity: style.opacity || 1,
                            pattern: {
                                shape: style.pattern === 'solid' ? '' : style.pattern,
                                bgcolor: 'white',
                                fgcolor: trace.color,
                                size: 10,
                                solidity: 0.7
                            }
                        };
                        plotTrace.width = style.width || 0.8;
                        plotTrace.base = style.base || 0;
                        break;
                        
                    case 'area':
                        plotTrace.mode = 'lines';
                        plotTrace.type = 'scatter';
                        plotTrace.fill = 'tozeroy';
                        plotTrace.line = { 
                            color: trace.color, 
                            width: style.thickness || trace.width,
                            dash: style.pattern || 'solid'
                        };
                        plotTrace.fillcolor = trace.color.replace(')', `, ${style.opacity || 0.5})`).replace('rgb', 'rgba');
                        break;
                }
                
                return plotTrace;
            });
            
            const layout = {
                title: document.getElementById('plotTitle').value,
                xaxis: getAxisConfig('x'),
                yaxis: getAxisConfig('y'),
                ...getLegendConfig(),
                hovermode: 'closest',
                plot_bgcolor: '#fafafa',
                paper_bgcolor: 'white',
                annotations: textBoxes.filter(tb => tb.visible).map(tb => ({
                    text: tb.content,
                    x: tb.x,
                    y: tb.y,
                    xref: tb.xref,
                    yref: tb.yref,
                    xanchor: tb.xanchor,
                    yanchor: tb.yanchor,
                    showarrow: tb.showarrow,
                    font: tb.font,
                    bgcolor: tb.bgcolor,
                    bordercolor: tb.bordercolor,
                    borderwidth: tb.borderwidth,
                    borderpad: tb.borderpad,
                    borderstyle: tb.borderstyle
                }))
            };
            
            // Apply plot dimensions
            const dimensions = getPlotDimensions();
            if (dimensions.width) layout.width = dimensions.width;
            if (dimensions.height) layout.height = dimensions.height;
            
            const config = {
                responsive: !dimensions.width && !dimensions.height, // Only responsive if no fixed dimensions
                displayModeBar: true,
                displaylogo: false
            };
            
            Plotly.newPlot('plotDiv', plotlyTraces, layout, config);
            
            // Update previews
            updateLegendPreview();
            updateTextBoxPreview();
            updateFramePreview();
        }
        
        function downloadPlot() {
            Plotly.downloadImage('plotDiv', {
                format: 'png',
                width: 1400,
                height: 900,
                filename: 'multi_trace_plot'
            });
        }
        
        function togglePanel(side) {
            collapsedPanels[side] = !collapsedPanels[side];
            
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const expandLeft = document.getElementById('expandLeft');
            const expandRight = document.getElementById('expandRight');
            const mainContainer = document.getElementById('mainContainer');
            
            if (collapsedPanels.left && collapsedPanels.right) {
                mainContainer.style.gridTemplateColumns = '0 1fr 0';
                leftPanel.style.display = 'none';
                rightPanel.style.display = 'none';
                expandLeft.style.display = 'block';
                expandRight.style.display = 'block';
            } else if (collapsedPanels.left) {
                mainContainer.style.gridTemplateColumns = '0 1fr 300px';
                leftPanel.style.display = 'none';
                rightPanel.style.display = 'block';
                expandLeft.style.display = 'block';
                expandRight.style.display = 'none';
            } else if (collapsedPanels.right) {
                mainContainer.style.gridTemplateColumns = '320px 1fr 0';
                leftPanel.style.display = 'block';
                rightPanel.style.display = 'none';
                expandLeft.style.display = 'none';
                expandRight.style.display = 'block';
            } else {
                mainContainer.style.gridTemplateColumns = '320px 1fr 300px';
                leftPanel.style.display = 'block';
                rightPanel.style.display = 'block';
                expandLeft.style.display = 'none';
                expandRight.style.display = 'none';
            }
        }
        
        // Initialize with sample data
        window.addEventListener('load', () => {
            const sampleData = `Time\tTemp1\tTemp2\tHumidity\n0\t20\t22\t45\n1\t21\t23\t46\n2\t22\t24\t47\n3\t23\t25\t48\n4\t24\t26\t49\n5\t25\t27\t50`;
            document.getElementById('dataInput').value = sampleData;
            parseDataInput();
        });
    </script>
</body>
</html>